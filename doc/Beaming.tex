\documentclass{article} 
\usepackage{underscore} % accepts  _ in text mode
\usepackage{ifpdf} % detects if processing is by pdflatex
\usepackage{/home/hkieffer/gong/tex/newcom}  % Hughs conventions
% USE ONE OF NEXT TWO:
\textheight=9.6in % \topmargin=-0.9in % 2016feb25 . display in xdvik
% \textheight=9.5in % \topmargin=-0.7in % ??? print with page numbers on H3

% \newcommand{\qj}{\\ \hspace*{-2.em}}      % outdent 1
\newcommand{\erfc}{\mathrm{erfc}}  % error function inside math
\newcommand{\qeq}{\hspace{25.mm}} % space original equation number to the right
%\newcommand{\qI}{\} % s
\newcommand{\bq}{$ < \! > \!   \! >$ } %  begin quote
\newcommand{\eq}{ $< \! \! < \! > $ } %  end quote

\newcommand{\qh}[1]{\\ \hspace*{#1.em} #1 \hspace*{0.4em} } %  LOOP indent
\newcommand{\qH}[1]{\\ \hspace*{#1.em}  \hspace*{1.3em} } %  LOOP additional

\newcommand{\qfo}[1]{$\Longrightarrow$ \textit{#1}} % indicate output file

% Use only one of the following two
\newcommand{\ql}[1]{\label{eq:#1} \hspace{1cm} \mathrm{eq:#1} \end{equation}}
%\newcommand{\ql}[1]{\label{eq:#1} \end{equation} } % for final
\title{Rough Surfaces and Thermal Beaming using KRC models}
\author{Hugh H. Kieffer  \ \ File=-/krc/Doc/DV3/Beaming.tex  2016Mar}
% josh  c=602-770-9724    ??> 208-331-7998
% davidsson icarus submitted
\begin{document} %==========================================================
\maketitle
\tableofcontents
\listoffigures
%\listoftables
\hrulefill .\hrulefill
% \pagebreak

\begin{abstract}
``Thermal beaming'', the non-isotropic thermal emission of a rough surface, is
  implimented as a post-KRC process.  KRC is first run for a uniform grid of
  slopes and azimuths, azimuths being ``cases'' in a single file and each type
  52 output file being named to indicate the slope used; these KRC runs normally
  are for a planetary set of latitudes and for a planetary year (after
  spinup). An IDL program reads the KRC files and progressively narrows in on
  particular surface points and season, models of surface slope distributions,
  and viewing directions. A set of observation wavelengths can be defined, and
  the surface facets at different slopes/azimuths (and thus temperatures) are
  summed based on their abundance in the slope model and their black-body
  radiance at each wavelength, yielding a forecast infrared spectrum. While
  designed primarily for airless bodies, an ``atmosphere-present'' mode accounts
  for an atmosphere grey spectral radiance at the appropriate viewing geometry.
\end{abstract}

Remaining Steps \begin{enumerate}    % numbered items 
%\item Recover the discussion in V34 design 
%\item Define the model set needed
 \item Generate the input file(s). Models must have consistent naming
\qi Ben* used large obliquity
\qii Have BenZ34Z00.t52 for  Z= A B J K L
\qii Need step 4, BenZ34Zeq.t52, for all 5
\qi BEn* used 2014 proper pole
\\ Have BEnA: 00 and eq; need B J K L
\qi run IDL krcinpgen;  mode 2. (see \S \ref{krcseq}) cat input file
\qi run IDL krcinpgen;  mode 3.  cat input file
 \item Run the models, inp= EZ2, takes 1 min.  inp=EZ3 take 40 min .
% \item Design the integation algorithm
% \item Write the integration routine
%\qi Look at starting with krchemi
% \item Run the integration, Study the results
 \item Complete the UG document
\end{enumerate}

The symbols \bq and \eq  are used here to bound direct quotes from articles.

ALERT: KRC runs before 2017feb23, V 3.4.3, had azimuth reversed.

ALERT: Some KRC runs had bad parameters. Revealed by BEAMSTAT
\vspace{-3.mm} 
\begin{verbatim}
Doing -------------->      40
     run       Ben/A       Ben/B       Ben/J       Ben/K       Ben/L       BEn/A
     Alb       0.100       0.030       0.030       0.030       0.030       0.100
    Iner     100.000      50.000      50.000     100.000      50.000     100.000
  PhoFun       0.250       0.000       0.250       0.250       0.000       0.250
    .tf2     299.608     316.158     315.803     307.434     316.158     299.608
    date     299.608     316.158     315.803     307.434     316.158     299.608
    .tf2     316.158     316.158     315.803     307.434     316.158     316.158
    TInt     316.158     316.158     315.803     307.434     316.158
    Tdel       0.000       0.000      -0.355      -8.725       0.000

delete L run, DONE
 redo A radiance+  
\end{verbatim}  

% \hrulefill MOVE: \hrulefill

\subsection{Notation \label{nota} }
Quotes and comments on journal articles may not follow this notation. There are some other local exceptions.
Geometry notation is in \S \$\ref{geom}
\\ $a$ or $\phi$ : azimuth angle  $0 \leq a \leq 360^\circ $ of down-dip; often relative to body North
\\ $\mathcal{B}$ :  the Planck function
\\ $i$ : incidence angle on regional horizontal (measured from the regional zenith)
\qii  or an index, hopefully clear by context
\\ $i'$ : incidence angle on individual tilt facet
\\ $\mu_0$ and $\mu_0'$: cosine of the above incidence angles
\qi  A facet is in the dark if either or both $\mu_0$'s is/are less than 0
\\ $e_v$ : emergence (viewing) angle relative to the regional zenith
\\ $e'_v$ :  emergence angle relative to an individual tilt facet normal
\\ $\mu$ and $\mu'$: cosine of the above emergence angles
\qi  A facet is invisible if either $\mu$'s is less than 0 
\\ $p$ probability function
\\ $\mathcal{R}$ : radiance
\\ $s$ or $\theta$ slope  $0 \leq s \leq 90^\circ $ [from horizontal] of a facet. $s$ is sometimes $\tan \theta$
\\ $T$ : surface kinetic temperature
\\ $T_b$ : brightness temperature
\\ TI : thermal inertia
\\ $\epsilon_\lambda$ : surface spectral emissivity 
\\ $\lambda$ :  wavelength or wavenumber
\\ $\psi$ : relative azimuth, commonly between incident and emission planes around the regional zenith.
\\ $\omega, \Omega$ : element of solid angle
\\ $\overline{\theta}$ : theta-bar, the mean slope of roughness
\\ \qfo : output file
% \\ $\bigcap$ : optional complexity

Subscripts: (not followed strictly)
\\ i : index of Hour, as in KRC output
\\ j : index of latitude,  as in KRC output
\\ J : index within a set of roughness mean slopes
\\ k : index of azimuth, as in KRC cases or tilt facets
\\ K : index of a KRC full tilt-set run (hundreds of slope/azimuth cases)
\\ m : index of slope (dip), as in KRC cases or tilt facets 
\\ l : within a set of wavelengths or wavenumbers
\\ n : within a set of view directions 

\section{Representation}

Beaming must depend upon a roughness model and the directions of the Sun and the
viewer.

Whatever the effect at a particular geometry, its magnitude is expected to
increase more than linearly with a roughness metric, such as a mean slope,
because, by symmetry, the derivative with slope must be zero at zero slope,
suggesting that the effect may be roughly quadratic with mean slope.

If beaming increases radiation at small phase angles, there is still a problem
of defining beaming at night; whatever model is used it should be continuous
across the terminator!

If there is beaming, the surface likely has composite TI, so that spectral
assessments computed from temperature distributions along slopes are in a sense
synthetic.

For one surface location $q$ at hour=H and latitude=L, the radiance spectrum from a smooth (flat) surface toward a viewer in direction  $v$ is, assuming Lambertian emission for each surface element: 

\qbn \mathcal{R}_q(\lambda,v) = \epsilon_\lambda \mathcal{B}(\lambda,T) \ql{1f}

For a rough surface, at the same location, composed of many facets oriented at slope $s$ and azimuth $a$

\qbn \mathcal{R}_q(\lambda,v) = \frac{\int_\Omega  \epsilon_\lambda \mathcal{B}(\lambda,T(s,a)) p(s,a) \ d\Omega } {\int_\Omega  p(s,a) \ d\Omega}   \ql{1p}

where 
\qi $\Omega$ is the projected solid angle of a facet as seen by the viewer
\qiii thus; proportional to $\mu'$
\qi $p(s,a)$ is the probability of a surface element having the orientation $(s,a)$

Includes the assumption that the surface roughness characteristics are the same
at all azimuths, and all facet azimuths are equally likely: $p(s,a) =
\frac{1}{N_a}P(s) $

For most work here, $ \epsilon_\lambda \equiv 1$ is assumed. Although this may
not be the value used in KRC runs, because most beaming analysis is relative to
a smooth surface, this is a simplification with no loss of generality.
  
NEED definitive statement about the relative area of each facet.
\qcite{Shepard95} p11715.3b \bq  Our synthetic
surfaces are generated so that the projected surface area of each facet is a constant; \eq

\vspace{ 2.mm} 

For a distant view of the globe:

\qbn \mathcal{R}(\lambda,\nu) = \frac{\oint_\omega \mathcal{R}_q(\lambda,\nu)\ \ d \omega } {2 \pi} \ql{glob}
where \qi $\omega$ is an element of solid angle over the visible side of the (presumed spherical) body.
 
Brightness temperature $T_B(\lambda) =  \mathcal{B}'(\mathcal{R}(\lambda))$ where $\mathcal{B}'$ is the inverse Planck function.


\subsection{Fundamental modeling approaches}
Two major ways to model:
 \begin{enumerate}    % numbered items  
\item \textbf{Coupled rough surface} These incorporate radiosity, coupling
  surface elements at each time step; e.g., \qcite{Lagerros98},
  \qcite{Vasavada99}, \qcite{Rozitis11}, \qcite{Paige13} To date, these seem to
  have used a homogeneous TI.

\item \textbf{Weighted tilted models} Calculate a set of models over a range of
  slopes and azimuths, and do a weighted sum of radiances; e.g.,
  \qcite{Bandfield08}, \qcite{Bandfield09}. Pragmatic approach is to do in steps: 
\qi 1)  Run large set of KRC models to type 52. 
\qi 2) Reformat to file of Tsurf only, then convert to radiance at a set of wavelengths
\qi 3) Weighted sum over slope/azimuth facets based on roughness model and view direction. 
\\ Approach is similar to what was done for the global mean surface temperature map.
\end{enumerate}

After either of the above, could considered \textbf{Post-processing}:
Parameterize effects using angle in meridian away for Solar incidence and
delta-Hour from solar incidence.

\qcite{Vasavada99}: both flat and craters, 32x32 square grid of facets,
 include planet curvature. 

p 184.5b: The fraction of energy emitted by element $i$ that is incident on
facet $j$ 
\qbn \alpha_{ij}=\frac{1}{\pi}\frac{\cos \theta_i \ \cos \theta_j
  S_j}{d_{ij}^2} \qen 
where $\theta$ are the angles between the surface normals and the line
connecting their centers, $S_j$ is the surface area of a facet and $d_{ij}$
their separation

If $F_j$ is defined as the flux of energy leaving element $j$, then the matrix equation:
\qb F_j=A_j \left( \sum_{i=1}^N F_i \alpha_{ij} + E_j \right) \qe
$A_j$ is the facet albedo and $E_j$ is the direct insolation.

\qcite{Ingersoll92} has analytic solution for ideal spherical craters

It would be straight-forward to incorporate a spherical crater model in KRC that
used the special property of spherical Lambertian craters for the radiosity and
accurately considered the fractional sunlight and shadow for each facet, but a
model run would hold for only the specified crater depth/diameter ratio.

\subsection{Bandfield model}

\qcite{Bandfield08} used KRC for an set of slopes at 2\qd ~dip and 20\qd ~azimuth intervals; (p 143.9a)

\bq The $\theta$-bar surface model used in this work produces an array of slopes
(2\qd~ intervals) and azimuths (20\qd~ intervals) along with a weighting to
define the contribution of each slope/azimuth combination to the
measurement. This weighting is based on the Gaussian statistics of the
$\theta$-bar parameter and the projection of each surface to a plane normal to
the viewing elevation and azimuth of the measurement. Self-shadowing of surfaces
is accounted for by applying a weighting of zero to all surfaces where the
observing spacecraft is below the local horizon of the individual surface
facet. It is assumed that surfaces blocked from the view of the observing
spacecraft by other surfaces are of a random nature and do not need to be
explicitly accounted for (e.g. Hapke, 1984). \eq

Done in IDL beaming.pro . \\ Use $\sigma$ of 6.288, 12.74 and 19.54 to get
$\overline{\theta}$ of 5, 10, 15; see Fig. \ref{bandfieldFig2}; this does not
match Bandfield08 Fig.2 .  Using $\sigma$ of 5, 10, 15 yields
$\overline{\theta}$ of 3.98, 7.9 and 11.7

\begin{figure}[!ht] \igq{bandfieldFig2BW}
\caption[Gaussian slopes ]{Gaussian slope distributions: solid lines are to
  match $\overline{\theta}$ values shown in labels of Bandfield08 Fig.2 . Dashed
  lines have input values of 5, 10 and 15 degrees.
\label{bandfieldFig2} bandfieldFig2.png  }
\end{figure} 
% how made:  Beaming @45 455
%      1.25834      1.27410      1.30268      1.25648      1.30507      1.28221
%      1.25835      1.27410      1.30266      1.25650      1.26609      1.28221

\pagebreak
\subsection{Treatment of roughness}  % ---------------------------------------

The individual cases in KRC do not treat statistical roughness, only allowing
the far field to be based on any prior model, typically a similar slope at
opposing azimuth. The far field could be a mixture of prior models.

In summing thermal radiance from unresolved roughness elements, must take into
account the probabililty of facets being hidden as a function of regional and
facet emergence angles and their relative azimuth.

 See \S \ref{geom} and \S \ref{nota} for definitions and notation.

Basic shadow function: use \qcite{Smith67} for the fraction of surface NOT in 
shadow (i.e., is in sunlight); using his notation. % (terms reorganized)

Paraphrazing: the probability $S$ that a point on a random rough (Gaussian height
distribution) surface, will not lie in shadow when the surface is illuminated
with a parallel beam of radiation at a fixed angle of incidence to the mean
plane and nadir viewing:

\qbn \underbrace{S(i,\overline{\theta})}_{\mathrm{here}} \Leftarrow  \underbrace{ S(\theta)}_{\mathrm{Smith67}} = \frac{ 1- \frac{1}{2} \erfc \left( \mu / \sqrt{2} w \right) } 
{\left( \sqrt{2/\pi} \cdot \frac{w}{\mu}
e^{-\mu^2 / 2w^2} -\erfc \left(  \mu / \sqrt{2} w \right) \right)/2  +1 } \qeq (\mathrm{Smith} \ 24 \ \mathrm{and} \ 21) \qen

where $i$ is the incidence angle, $\mu = \cot i $; $w^2$ is the mean-square
surface slope, $w \equiv \overline{\theta} $

Note: Smith $q$ is slope component in the incident plane; + being surface
getting higher toward the source. $\theta$ is the incidence angle from
zenith. Hence the statement at p4060.4b \bq $S(0)$ will clearly be unity if
$q_o$ is less than $\cot \theta$ \eq

Smith section on optical shadowing (Eq. 26 to 38) assumes viewer is in the plane
of illumination (relative to regional zenith), which is quite restrictive.

  For off-nadir views,  \qcite{Bandfield15}, follows the approach of \qcite{Hapke84} with the approximation ``the shaded fraction observed'':
\\ when $e_v>i$: $S_v(i,\overline{\theta},\psi)=S_n(i,\overline{\theta}) \left( 1-F(\psi) \right) $
\\ when $e_v<i$: $S_v(i,\overline{\theta},\psi)=S_n(i,\overline{\theta}) -S(e,\overline{\theta})F(\psi) $
\qi  where $\psi = \phi_i-\phi_e$  and $F(\psi) \equiv -e^{-2 \tan \psi/2} $

[Note:  \qcite{Bandfield15} p359b around equations 3 and 4 refers to $S$ as ``the fraction of shadowing'' and refers back to his Eq. 1 rather than the proper 2. His use of $S$  for both sunlit and shadowed areas is confusing. ]

Because $F$ is a \textbf{decreaseing} function of $\psi$  from 0 to $\pi$;
 expressing these in terms of the sunlit fraction $H$ using the Smith definition of S:
\\ when $e_v>i$: $H(i,\overline{\theta},\psi)= 1- \left( 1-S(i,\overline{\theta})  \right)\cdot \left( 1-F(\psi) \right) $
\\ when $e_v<i$: $H_v(i,\overline{\theta},\psi)=S(i,\overline{\theta}) -\underbrace{\left( 1-S(e,\overline{\theta}) \right)}_{dark} \left( 1-F(\psi) \right) $


These relations are implimented in \np{hiding.pro} and the production version
\np{hide2.pro} as

\qb S(i,\overline{\theta}) =  \frac{ 1- \frac{1}{2} \erfc \left( \mu / \sqrt{2} w \right) } 
{1  - \frac{1}{2} \erfc \left(  \mu / \sqrt{2} w \right) 
+ \frac {1}{\sqrt{\pi}\sqrt{2}} \frac{e^{-\mu^2 / 2w^2}}{\mu/w} }
= \frac{1-E}{f_1*f_2/c -E +1} \mc{Or} 
\frac{B}{B+\frac{e^{-a^2}}{2\sqrt{\pi} \ a} }
\qe
where $c=\mu/w$, \ \ $a=c/\sqrt{2}$ , \ \ $E= \frac{1}{2} \erfc \left( a \right)$ or zero if $a>7$, \ \  $f_1= \sqrt{2/\pi}/2 $, \ \ $z=c^2/2$, \ \ $f_2= e^{-z}$ or zero if $z > 70$
\\ Or $a=1/(\sqrt{2}w \tan i)$ and $B=1-\erfc(a)/2$


$S$ for shadowing can be used to set the proportion of facets which are at their
``cold'' state, However, $S$ for hiding is of little use, as it is independent
of facet attitude. Facets are all weighted by their projected area, proportional
to $\mu' \geq 0 $.

Possible (realistic) complications difficult to include:
\qi $S$: tilts distribution is not uniform with elevation; e.g., valleys are flatter than mountain tops. 
\qi $S'$: tilt distibution is influenced by geology; e.g, aligned ridges

For the non-null treatment, evaluation of $S$ or $S'$ requires $\mu_0$, $\mu$,
and $\psi$

\subsubsection{Azimuth relation \label{azi} }  %.............................

For relative azimuth dependence, allow either the Hapke relation $f_H(\Psi)=\exp
  \left( -2 \tan \frac{\Psi}{2} \right)$ or the simple  $f_C(\Psi)=\frac{1+ \cos \psi}{2}$. The Hapke relation drops rapily near zero and has discontinuous derivative there, the second function has continuous derivatives everywhere, as does $F_e=f_c^e$, which matches $f_H$ everywhere to $<.25$ and to $< .01$ beyond 92\qd.


\subsubsection{Shadow:Hiding function requirements}  %

 Define here: S is  ``in sunlight'' function, depends only on incidence angle i and roughness r

H is the ``visible in sunlight'' function, depends upon i,r and emergence angle e and either phase angle g or azimuth angle A. 

 Properties of H:
\qi H( e$\geq$i,A=0)  $\equiv $ 1
\qi H (i, e=0) $\equiv $ S
\qi must be no discontinuity as e passes through i
\qi Desireable to be expressed as function of A rather than  g
\qi $\frac{\partial H}{\partial g} \geq 0$ and =0 at A=180\qd
\qii and $\equiv 0$ at A=0 if $ i \neq e $
\qi $\frac{\partial H}{\partial A} \geq 0$ and ==0 at A=180\qd
\qii and $\equiv 0$ 0 at A=0 if $ i \neq e $
\qi $\frac{\partial H}{\partial g} $ should be a weak function of A

Simple function that does this, except first derivative is discontinuous at i=e,: implimented as HHIDE: 
\qi At A=0, if $e \leq i, \ \  H_0=S_i+(e/i)(1-S_i)$; else $H_0=1$, the shadows are hidden
\qi At A=$\pi, \ H_p=S_iS_e$
\\ $H=F(\psi)H_0 +  \left( 1-F(\psi) \right) H_p$
\qi Could use either i and e or, being careful of signs, $\mu_0$ and $\mu$


 

\subsection{Issues}  % ---------------------------------------------
Importance of far-field thermal radiation, e.g., tilted surface viewing a flat
filed below the horizon? Requires KRC version 3.4+ to treat this.

 Roundoff:
\qi sumQ= summing radiance only at innermost loop 
\qi sumR =summing radiance at each loop level
\\ For 4 views and 11 wavelengths, mean value of sumQ/sumR=0.999961, StdDev=3.26951e-05

\subsection{From the literature}

\subsubsection{Emery 2014}
The Near-Earth Asteroid Thermal Model (NEATM) \qcite{Harris98} is unlikely to be
adequate for Bennu, with an TI of about 300., but it is used by \qcite{Emery14}
for their Table 5.
\qi p24.6a, beaming parameter derived from $D_{eff}$ and $T_{SS}$
\qi p24.7b spherical section craters serve as macroscopic roughness elements 
\qi $\eta$ is not used in this model. In this step, we continue to assume that the
asteroid is spherical.
\qi p32.6b re bedrock TI. CM meteorite Cold Bokkeveld has I=768. CK chondrite NWA 5515 has I=1450 

Gundlach, B., Blum, J., 2013. A new method to determine the grain size of
planetary regolith. Icarus 223, 479–492.

Emery, J.P., Sprague, A.L., Witteborn, F.C., Colwell, J.E., Kozlowski, R.W.H.,
Wooden,D.H., 1998. Mercury: Thermal modeling and mid-infrared (5–12 lm)
observations. Icarus 136, 104–123.


\qcite{Shepard95} For a fractal surface: \bq \qb P(s)=\frac{s}{s_0^2}e^{-(s^2 /
  2s_0^2)} \qeq (13) \qe where $P$ is the slope histogram function. \eq

\bq Our synthetic surfaces are generated so that the projected surface area of
each facet is a constant; we therefore utilize the modified Rea, Hetherington,
and Mifflin probability density function, PRHM'(0) [Simpson and Tyler, 1982,
  equation A5]. The normalization for this function is
\qb  2 \pi \int_0^\frac{\pi}{2} p_\mathrm{RHM'}(\theta) \sin \theta \ d \theta \ = \ 1 \qeq (15) \qe 

Normalizing (13) to this form gives 
\qb p_\mathrm{RHM}(\theta)=\frac{1}{2 \pi \tan^2 \theta_\mathrm{rms} } \sec^3 (\theta) \ e^{-\tan^2 \theta / 2 \tan^2 \theta_\mathrm{rms} }  \qeq (16) \qe

The secant term rises in part from the conversion of (13) in
terms of slope into degrees. Equation(16) is a Gaussian function with rms slope tan$(\theta_\mathrm{rms})$ [Simpson and Tyler, 1982]. \eq

\subsection{Processing step 3; Integration \label{s3}} 


Step 3 : Loop over KRC model $K$  and over roughness $J$, for each view $n$ do 
\qb \mathcal{R}(\lambda ,H,L)_n = \sum_{m=1}^\mathrm{nSlope}  
\sum_{k=1}^\mathrm{nAzi} P(\theta_m,\overline{\theta}) \mu'_{ijn} 
\ \left[ S(i,e_v,\psi,\overline{\theta}) \mathcal{R}(\lambda,k,m,H,L) 
+\left(1-S(i,e_v,\psi,\overline{\theta}) \right) \mathcal{R_S}(\lambda,k,m,H,L) \right] \qe

\qbn  / \sum_{m=1}^\mathrm{nSlope} \sum_{k=1}^\mathrm{nAzi} P(\theta_m,\phi_k) \mu'_{ijn} \ql{igl}

where the subscript $n$ runs over a set of viewer
directions. $S(i,e_v,\psi,\overline{\theta)})$ is the shadow function being used
and $\mathcal{R_S}$ is the radiance for the temperature in the shade.

This hiding relation is used for shadowing of a facet from sunlight, where the
shadowed fraction is assumed to be at a lower temperature.
% , and for visibilty of a facet to the viewer (spacecraft), where the ``shadowed'' fraction is assumed to be hidden and does not enter the radiance sums.

The looping could be made more efficient by putting the KRC models near the
inner-most loop in @64 such that the geometry calculations are done once.

From step 3, can make either unresolved object (4a) or global image  (4b)

Step 4a; for unresolved object. For each roughness and model:
Impliment \qr{glob} as, only where $\cos e'_n > 0 $:

\qbn \mathcal{R}(\lambda)_n = \sum_{j=1}^\mathrm{nLat}
  \sum_{i=1}^\mathrm{nHour} \mu_{ijn} \mathcal{R}(\lambda ,H=i,L=j) \ / 
\  \sum_{j=1}^\mathrm{nLat}  \sum_{i=1}^\mathrm{nHour} \mu_{ijn}  \ql{rdot}


Step 4b; for resolved object, map $\mathcal{R}(\lambda ,H,L) $ onto the visible
hemisphere; for each roughness and model.

\subsubsection{RMS dips and slopes}
For a surface as defined by \qcite{Shepard95} Eq. 13
\qb P(\tan \theta)=\frac{\tan \theta}{\tan^2 \theta_0} \cdot e^{-\frac{\tan^2 \theta}{2 \tan^2 \theta_0} } \leftrightarrow  P(s)=\frac{s}{s_0^2}e^{-(s^2 / 2s_0^2)} \qe

$d \Omega = \sin \theta \ d \theta $

Using $s\equiv \tan \theta$, the mean-square slope is 
\qbn w^2= \int _0^{\pi/2}\frac{\tan \theta}{\tan^2 \theta_0} \cdot e^{-\frac{\tan^2 \theta}{2 \tan^2 \theta_0} }  \sin \theta \ d \theta \Rightarrow \frac{2}{a}\int _0^{\pi/2} \sin x \tan x e^{-\tan x^2/a} dx     \qen 
where $a=2 \tan^2 \theta_0$.   No analytic solution found. Numerical integration yields a $w^2$ that peaks near 30\qd, clearly something is wrong.

\begin{verbatim}
 Note:integration:  use http://www.wolframalpha.com/ Compute an improper integral
 timed out
\end{verbatim}  
% Testing symbol sizes: \qb a / b] \ \ a \big/ b \big] \ \ a \Big/ b \Big] \ \  a \bigg/ b \bigg]  \ \  a \Bigg/ b \Bigg] \qe

Numerous definitions are evaluated in \np{beaming.pro} @45 451 454

\subsubsection{Modification for geologic bias} %.........................

Allow modification of shadowing and visibility to account for a geologic influence on the
distribution of dip with elevation; see the section on ``Implication of
geology'' in \nf{slopes.tex}. Note that facet distributions for composite surfaces only apply to scales greater that the diurnal skin depth. KRC     A simple approach is $
S'(i,\overline{\theta},\delta) = S(i,\overline{\theta}) F(\delta)$ where
$\delta$ is the dip angle of a facet, and require $\int_0^{\pi/2}
F(\delta)p(\delta) =1$ where $p(\delta)$ is the population function of dips and
$\int_0^{\pi/2} p(\delta) \ d\delta =1$.

Define $F$ as a Chebyshev polynomial of the first kind of degree 2 in
$x=2\delta/\delta_\mathrm{max} -1$ [which ranges over -1:1]; i.e.,
$Y=1+c_1x+c_2(2x^2-1)$. Define $F=Y/\int_0^{\pi/2} Y(x)p(x)\ dx $ to accomplish
the required normalization.

However, this approach could cause $S'$ to fall outside the physical limits: $ 0
\leq S' \leq 1$

Physical requirements force some complication; i.e. that $F$, and hence $Y$,
must not be negative anywhere, that $ 0 \leq S' \leq 1$, and that $S'
\rightarrow 0$ as $i \rightarrow 90$\qd~ and $S' \rightarrow 1$ as $i
\rightarrow 0$.

 The $S$ function has all attributes required of $S'$, which suggests adjusting
 $\overline{\theta}$ as a function of $\delta$; i.e., \qbn
 S'(i,\overline{\theta},\delta) = S(i,F(x)\overline{\theta},\delta) \qen Then,
 $Y$ decreasing with $\delta$ would decrease the shadowing of the steeper
 slopes; e.g., $|c_2| << |c_1| $ and $c_1 < 0$ .

Implimented, but generally not used.

\section{Intermission on definition of mean value}

Given a continuous population function $p(x)$ evaluated at a discrete set of points $x_i$ to generate the set $p_i$.; e.g., $x$ could be angle or $\tan \theta$ .
\qi the mean value of $p$ is $ m=\frac{1}{N} \sum_{i=1}^N p_i $ and
 the root-mean-square (RMS) of $p$ is $ r=\sqrt{ \sum_{i=1}^N p_i^2 \big/ N }$.
\\ Assuming that the $x_i$ are uniformly distributed, then
\qi the mean value of $x$ is $ m_x=\sum_{i=1}^N p_i x_i \big/ \sum_{i=1}^N p_i $ 
and RMS of $x$ is 
$ r_x=\sqrt{ \sum_{i=1}^N p_i  x^2_i  \big/ \sum_{i=1}^N p_i }$.

If the distribution is normalized so that $\sum_{i=1}^N p_i =1$ 
 then  $ m_x=\sum_{i=1}^N p_i x_i $
 and the RMS is $ r_x=\sqrt{ \sum_{i=1}^N p_i x^2_i }$

\vspace{4.mm}

If the intervals represented by the distribution are not uniform but have width $w_i$, 
\qii then $ m_w=\sum_{i=1}^N w_ip_ix_i \ \big/ \ \sum_{i=1}^N w_ip_i$ and 
\qb r_w=\sqrt{ \sum_{i=1}^N w_ip_i x^2_i\ \Big/ \  \sum_{i=1}^N w_ip_i } \qe


Specifically, if computing the $p(s)$ distibution at uniform points in angle,
but doing the statistics along a scale of slope, then $w= \Delta_i (tan \theta)
\sim d \ \tan \theta = \sec ^2 \theta \ d \theta $, where $\Delta_i$ is assessed
between the midpoints $(\theta_{i-1}+ \theta_i )/2 $ and $(\theta_i +
\theta_{i+1} )/2 $. Note that scaling $w$ or/and $p$ makes no difference.

\subsection{Just what is the mean slope}
Options in beaming.pro @451
\qi Can try either 2 or pi as divisor in exp
\qi Can try either Hapke or RMS for a roughness index
\qi ? can weight with $d \theta$ or  $d \tan \theta$

\section{Geometry notation \label{geom}}

 The notation system used here was developed so that variable names in code can
 follow closely the mathmatical representation.  [ Largely extracted from \nf{-/xtex/Geomath/matrix.tex} ]  
\\ Briefly, in code names are [to][from][system][component] with component ``xx'' representing an X,Y,Z triple (``xxx'' indicates that this is an array of such triples)
\qi A final ``u'' indicates this is a unit vector. 
\qi In code, generally use lower-case version of the upper-case math symbol
\qi E.g., vqdxu is $\qf{VQ_D}$ unit vector from $Q$ to $V$ expressed in the $D$ system.

\vspace{2.mm}
Locations (vector ends) used here:
\\ N = Unit vector along the local surface normal.
\\ P = center (of mass?) of the target body (Planet or satellite)
\\ Q = surface intercept location (of the instrument optic axis)
\\ V = Vehicle or spacecraft; e.g., viewer, imager, camera. Where one is looking FROM
\\ W = local slope element of a KRC model
\\ Z = generic, the +Z-axis direction of the given coordinate system or surface normal.
 
\vspace{2.mm}
Orientation systems used here: all are X,Y,Z right-hand. 
\\ A = Astronomic: Master reference inertial system (ICRF or J2000) 
\qi  +Z toward the Earth's north pole, +X toward the vernal equinox.
\qii +Y is $Z \times  X $, the third axis is defined by a cross product in all systems. 
\\ D = Day: Target body spin axis and true solar midnight. Rotates annually
\qi +Z toward body's right-hand spin axis, +X in the true solar midnight meridian.
\qii Hour increases in a right-hand sense
\\ S = Surface: Regional 'horizontal' surface parallel to the ellipsoid surface. Rotates daily
\qi  +Z toward the regional zenith, +Y toward ``north'' Right-hand spin axis (degenerate at a pole).
\qii  +X right-handed (``East''), = Y cross Z. X and Y are in the ``horizontal'' plane.
\\ U = view: so that +Y=Up will be toward North and  +X=right will be eastish in a view of the globe
\qi +Z from body center to the viewer, +Y toward ``north'' Right-hand spin axis
\qi +X right-handed (``East-ish''), = Y cross Z.

\vspace{2.mm}
Other symbols:
\qi $\bullet$ is the dot-product 
\qi $\times$ is the cross-product 
\qi $\overline{QV}$ is the magnitude (distance) between $Q$ and $V$
\qi $\star$ indicates conventional matrix rotation, implemented in IDL by the \#
 operator.
\qi \trm{DA} is the rotation matrix taking vectors from the $A$ to the $D$ system
\qii Last two letters in code are 'rm'. May to append a 9 if a 9-element 1-D array rather than a 3x3 array.
\qi  $\qct{DA}$ is the coordinate transform that rotates the axes of the $A$ to 
coincide with the axes of the $D$ system
\qii  The last 2 letters in code are 'ct'
\qi E.g., $\qf{ZQ_S}$ is out along the ellipsoid normal at (latitude,Hour) in the $S$ system;  components are by definition [0,0,1] 


Note that $\qrm{AB}^\mathrm{T} = \qrm{BA}  = \qct{AB} $
where $^\mathrm{T}$ means the transpose.

BEWARE: It is a peculiarity of my IDL rotation package that vector rotations to
S from D are done by the ROTVEC routine using the \tct{SD} matrix constructed by
use of the ROTAX routine to rotate the axes of the D system onto the axes of the
S system.


 % \pagebreak
\subsection{Specifics \label{geos} }
KRC azimuths are: Increasing east from N (clockwise) [but be aware of sign
  error that had them West from North in versions 232 (and possibly earlier) to
  342].

S system azimuths are mathematical; from +X (east-like) toward +Y (north)
Thus $\phi_S= 90-\phi_\mathrm{KRC}$ in degrees.

 Specify viewer directions and surface points in the $D$ system, but do inner
 loop calculations in the $S$ system for efficiency. Generate slope normals in
 the S system $\qf{ZQ_{j,k}}$ where $j$ is the azimuth index and $k$ is the
 slope index.
\qi Get $\qf{VP}  $ direction in D system
\qii Assume for now the target body is small relative to the observer distance so that $\qf{VQ} \equiv \qf{VP}$ 
\qi Then the view factor for a tilt element is  $f_{jk}=\qf{VQ} \bullet \qf{ZQ_{j,k}} $ and must constrain  $f \geq 0$.
\qi $\qf{VQ_S} = \qrm{SD} \star  \qf{VQ_D}$  

Make \tct{SD} coordinate transform by rotating the D axes to coincide with S axes
\qi 0) Start with identity matrix: 
\qi 1) Rotate around the pole from midnight to Q hour \qt Rotate around Z by 15*Hour of S
\qi 2) Rotate around Y from N pole to Q latitude \qt Rotate around Y by (90 - Lat. of S). X is now toward South
\qi 3) Rotate around Z 90\qd~ to move +Y from east to north \qt . Or exchange axes

\subsubsection{Day to viewer transform}
Z axis of viewer-to-body, U, system is in the viewer-to-body direction. 
Y-Z plane of U system to include the spin axis with positive Y value, so Xu in D system, which is normal to YZ plane, must be along Zu x Zd (both in D). Then Yu in D is Zu x Xu (both in D)

If at virtually infinite distance, can use oblique orthographic projection, which involves only a rotation.  Construct the rotation matrix from D to ORTH by 
\qi Create identity matrix. rotate around Z by hourLon, then rotate around Y by latitude to get ODrm
\qi Rotate all hourLon, lat points by ODrm, points with positive X are on the backside 
\qi Treat Y as to the right and Z as up, so a viewer above the equator at noon would get a conventional hemisphere view.


\section{Implimentation using KRC}
Use Bandfield approach; precompute data sets of tilts as cases in
normal KRC runs; save as type 52. Azimuth at 20\qd~ intervals; slope at 2\qd~
intervals up to 40\qd; each slope is one .t52 file. 361 cases per material

Or up to 60\qd, 541 cases per material..

A basic simplification is to assume that all surface tilt azimuths equally probable.
 
Use equal-area zones from pole-to-poles, with one centered on the equator, so
there is an odd number total; $N=2j+1$.  Normalized area of a zone is: $\sin
\theta_2 - \sin \theta_1$ where $\theta$ is the zone boundary latitude. Thus
$\delta \equiv \Delta \sin \theta = 2/N $.  Compute the model at the
area-weighted center of the zones; $sin \theta= \delta/2+i \delta \ ; i=0:n-1$ .

 For example:
\begin{verbatim}
j=9 & n=2*j+1
dels=2./n
sa=-1.+dels*(0.5+findgen(n))
alat=!radeg*asin(sa)
 print,alat[0:n-1], format='(10f7.2)'
 -71.33 -57.36 -47.46 -39.17 -31.76 -24.90 -18.41 -12.15  -6.04   0.00
   6.04  12.15  18.41  24.90  31.76  39.17  47.46  57.36  71.33  
\end{verbatim}
\subsection{Opposing slopes}
 To account for the tendency of a slope in rough terrain to be facing slopes of
 the opposite azimuth, e.g., a west-facing slope  is likely to view
 east-facing slopes in the far field, KRC can be run with each and every
 slope and azimuth of a tilt-run using a far-field file with a tilt near the RMS
 slope value and an azimuth different by 180\qd.

This is done with the following steps, generally using the routine
\np{krcinpgen.pro} which can be called by BEAMING @51. KRCINPGEN is firm coded
to do 20\qd~ azimuth spacins and 2\qd~ slope spacing to 60\qd.
\begin{enumerate} % numbered items

\item Edit an input file similar to \nf{beamP.int} or \nf{Bentop} that has all
  the input parameters but ends with the last change card for the first case.

\item Run KRCINPGEN for style 2, and follow the prompt to concatonate to
  generate an input file like \nf{Z2.inp} which will generate a flat file and
  also a type -1 for each azimuth (20 degree spacing) for a single slope.

\item Run KRC on Z2.inp, takes about 45 seconds.

\item Run KRCINPGEN for style 3, and follow the prompt to concatonate to
  generate an input file like \nf{Z3.inp} which will generate a full set of azimuths and slopes using the opposing azimuths from style 2, each with output of .tm1 .

\item Run KRC on Z3.inp, takes about  40 minutes.

\item Run KRCINPGEN for style 4, and follow the prompt to concatonate to
  generate an input file like \nf{Z4.inp} which will generate a full set of azimuths and slopes using the opposing azimuths and slopes from style 3.

\item Run KRC on Z4.inp, takes about 30 minutes. This produces a .t52 file set that constitutes a  'eq'  ``tilt-run'' 

\end{enumerate} 


\subsection{Two pole sets}

Through an error in the direction of the spin axis, the computed sub-solar
latitude ranged over $\pm 33$\qd, a factor of 6.72 larger than for Bennu, for
which on KRC seasonal dates the range is $\pm 4.93$\qd; See
Fig. \ref{BenSdec}. This error was discovered after 5 tilt-set runs, and
retained for more of the runs as potentialy allowing more informative
analysis; this artifically large obliquity is usefull for checking reasonableness of view geometry. 

\begin{figure}[!ht] \igq{BenSdec}
\caption[Sub-solar latitude]{Subsolar latiitude (solar declination) for Bennu as
  a function of date; the values are derived from a quadratic fit to the
  down-going insolation at noon for each KRC season.  Solid lines and + signs
  are for Bennu; dashed lines are value for the beaming runs, reduced by a
  factor of 6.72 and offset by 20 days
\label{BenSdec}  BenSdec.png  }
\end{figure} 
% how made: 

Below are the wrong and Hergenrother 2014 PORB outputs
\vspace{-3.mm} 
\begin{verbatim}
    
 2013 Aug 23 08:11:19=RUNTIME.  IPLAN AND TC= 405.0 0.00000 Bennu   WRONG   
   405.0000       0.000000      0.3564448E-01  0.1053292       1.156605    
  0.2037319       1.126004      0.4090926       0.000000      -1.504474    
  -1.185079       0.000000       0.000000       436.4232       4767.211    
  0.1790608       0.000000       2.001070       0.000000       0.000000    
   0.000000     -0.4171197      0.7619694     -0.4953924      0.9088515    
  0.3497078     -0.2273616       0.000000     -0.5450751     -0.8383872  

PORB:2014jun10 2016 Oct 13 20:58:06 IPLAN,TC= 406.0 0.00000 Bennu
   406.0000       0.000000      0.3596894E-01  0.1053296       1.155811    
  0.2037451       1.126391      0.4090926       0.000000      -1.136384    
   1.512153       0.000000       0.000000       436.6481       3894.142    
  0.1790609       0.000000       2.289608       3.056127       0.000000    
   0.000000     -0.6584910      0.7498416     -0.6424240E-01  0.7525886    
  0.6560875     -0.5621005E-01   0.000000     -0.8536191E-01 -0.9963500
\end{verbatim} 

 2018 Sep 12 21:53:27 first use of the proper Bennu pole and updated orbit.
 Files distinguished by the e in Ben now uppercase: BEn
MJD of first output should be 6900.00, DJUL=10.9162


\subsubsection{Dates}
Beginning in 2016, the DJU5 run dates have been kept the same, and generate
output files with DJU5 coverage of 5764.2720 to 6200.6960; Bennu encounter is
2018dec03=6911 So, subtract 2*year=2*436.4232=872.846 from real MJD up to
7073.54=2019may14, then subtract 1309.27 . Encounter day in KRC runs is 6038.

In the BEn runs, MJD dates cover the first year of actual mission. Encounter day is 6911.

However, for testing, want large sub-solar latitude,   so use the Ben set near 5500.


\subsection{Thoughts not incorporated yet}

For distant observations, if the body shape is not spherical one could weight
each hour/latitude grid point with a form factor to reflect the relative size of
each grid facet. This is an excellent approximation (exact) where the body is
not concave

Although in the KRC runs, non-Lambertian emission can be modeled, in the
integration of rough surfaces, each facet is initially assumed to have
Lambertian emission; this Lambertian assumption could be relaxed with additional
code.
 
2016oct24 Post Banfield phone call: 
\\ Probable temperature of the far field for rough surfaces will depend strongly
on azimuth and time of day. E.g., west-facing slope in the afternoon will see
east-facing, and hence hot, slopes.
 

\subsection{Thoughts}

 Small-scale effects (less than about 5 times the diurnal skin depth) can only
 dimish the thermal differences with slope and hence the beaming effect.

Surface hiding at large emission angles must attenuate the shallow slopes. 
Shadowing at large incidence angles must attenuate the shallow slopes.


% \pagebreak
\section{File naming: critical}

 KRC runs will commonly involve hundreds of files that must be named
 consistently and be traceable to KRC parameters.  Must trace to conditions of
 the run and to the far-field set that may have been used. 

Ensure that the last character(s) before the extension specifies the file type,
 unlsee the extension does that, e.g., '.t52' .

\subsection{pre 2018 scheme}
Did not propagate the farField part of names
\vspace{-3.mm} 
\begin{verbatim}
parf: File names
  0 DIR for krc beam set            = /work1/krc/beam/
  1  stem " "                       = Beam
  2   run unique                    = P
  3  " slope part [.t52]            = 30
  4 mjd [auto][.bin5]               = 1234
  5 waveset number                  = 1
  6 Surface site, start with letter = Q1
  7 Comparison stem + uniq          = BeamBen
  8 CubUniq [constructed]           = KLA
  9 Surface point [constructed]     = G
 10 Output dir    \ any "=" will    = =
 11  "    stem    | be reset        = =
 12  " run unique / to item 0 to 2  = =

@280 read set of:     parf[ 0]+parf[ 1]+parf [2]+sti2[jslo]+'.t52'
@28 write Tsur       parf[10]+parf[11]+parf[12]+parf[14] .bin5
438  write radiance  parf[10]+parf[11]+parf[12]+parf[14]+'w'+parf[5]
\end{verbatim}  

\subsection{2018 design}
General scheme is in Table \ref{fame}
\begin{table} \caption[File naming]{File naming}  \label{fame}
\begin{tabbing} 
WW \= WWWWWW \= WWWW \= WWWW \=WWWW \= WWWWWWWW \=   \kill 
i \> what \> symbol \> parf \> pars \>example \> discussion \\
0  \> top Dir \> AAA \> 0 \> 0 \> /work1/krc/beam/  \>   \\
1 \> object  \> X \> 1 \>   \> Ben \> Geom Matrix, period, seasons, lats, ... Maybe  DIR   \\
2 \> material\> x\> 2 \>   \>  B \> inertia, photoFunc, ...  \\
3 \> slope   \> ss \> 3/auto \> \>  20  \> 2-digit, slope in degrees  \\
4 \> Far material \> F \> 4 \>  \> C  \> alpha, prior set must exist  \\
5 \> far slope  \> ff \>  5 \>   \> 30 \> 2-digit, prior set must exist  \\
6 \> seperator  \> a \> fixed \> auto  \> a \> always exactly this  \\
7 \> azimuth    \> zz \> auto \> auto  \> 20  \> 2-digit, azimuth in degrees / 10  \\
8 \> extension  \> .ext \> auto  \> auto \> .tm1 \> fixed by KRC conventions  \\
\end{tabbing}
\hrulefill \end{table}  

 Will assume for now that a sloped model using a farField views the opposite
 azimuth.  In order of generation, these are:
\begin{description}  % labeled items   
\item [KRC input] Xx \ Normally named  -/krc/tes/*.inp 
\item [KRC print] Xx \ Normally named after the input file, with extension .prt 
\item [far-field files: flat] AAAXxflat.ext \ As for sloped below, without slope and azimuth
\item [farField files: sloped] AAAXxssFffazz.ext  \ Name traceable to their input file, also must contain both slope and azimuth and additional parts for the farFiles that may have been used in their generation.  Typically 540 of these, so put is own directory under AAA based on Xx.   
\item [t52 multi-azimuth] AAAXxssFff.ext \ Need all of the above except azimuth. Only ss vary through a set. 
\item [date files] parf 10+11+12 +14 = AAAXx 1234slop.bin5 and --flat.bin5 where 1234 is KRC  date (true?].  
\qi @280 make reading parf[0]+parf[1]+parf[2]+sti2[j]+parf[4]+'.t52'
\qi  @28 Writes two file: .  @29 read
\item [radiance]   @43 make parf 10+11+12+14 +'w'+parf[5]'+'w' .    @438 Write, @439 read
\item [integrated]  make @64 avrr=average radiance, @1435 into 4D cube, @1435 write cube =  parf 10+11+8+14+9+'w'+parf[5]+.cub 
 \end{description}
\begin{verbatim}

/work1/krc/beam/  Ben L 34 L 00 .t52     .t52 all azimuths out
/work1/krc/beam/  Ben A 36 A eq .t52
\--------------/  \-/ | ss | \/ \-/
       0          15  2  8 2  8  9   


/work1/krc/beam/ BEn B 30 B 00 a  00.tm1    FarIn
\--------------/ \-/ | \/ | \/ |  \/\--/
       0         15  2  8 2 17 19   

/work1/krc/beam/ BEn B 30 B 00 a  00.tm1   FarOut
\--------------/ \-/ | \/ | \/ |  \/\--/
       0         15  2  8 2 17 19   

\end{verbatim}    
\subsection{2018 sep compromise}

To maintain consistent format, potential successive generations of runs must use
unique and constant 3 characters for the Fff part of the output .tmn; e.g.,
AAAXxssUUUazz.tm1 where only ss and zz vary through a set.

To minimize code changes, start with 2017 scheme and 
\qi allow parf[1] to include a directory
\qi add parf[11] to deal with Fff

E.g., new run series I=50, keihm. Create dir beam/BenB/  

\subsection{Common KRC run sequence \label{krcseq}}
 Sequence of KRC runs
\\ 1: Flat, \qfo beam/BEnZ/Zflat.tm1 \ \qfo beam/BEnZ00_00.t52 
\qi  Normally runs as first part of step 2
\\ 2: Slope=30 with flat farIn: \qfo beam/BEnZ30Z00.t52  
\qi  and for each azi \qfo beam/BEnZ/Z30Z00a02.tm1
\\ 3: Set of slopes with farIn of slope=30. at opposite azimuth
\qi   \qfo beam/BEnZssZ00.t52 \ \ ss $\equiv$ slope
\qi If planning step 4: \qfo beam/BEnZ/Z02z30a02.tm1 etc for each azimuth
\\ 4: Set of slopes with farIn of same slope at opposite azimuth (from Step3)
\qi   \qfo beam/BEnZ02Zeq.t52


number represents parf[n]

KRC steps: (number in a name represents parf[n])

1. Generate Top part of beaming master input file by hand;
\qi  Edit it for specific inertia, albedo, etc

2. Use KRCINPGEN to generate step2 cases. This example for the proper pole
\qi 7,15,23 should start ZE [for proper pole], where Z is the current model
\qi 2,16,24,should start Z 
\qi 18:  Z00 
\\ Concatonate onto BEntop, check initial change lines,  and run KRC.  70 sec.

3. Use KRCINPGEN to generate step3 cases. Concatonate onto top, and run KRC. 40 minutes 

4. Option:  Use KRCINPGEN to generate step4 cases, edited for equal-slope farFieldIn. 
\qi 2 [E]X4,  8 Aeq, 17 =, 18 a30, 21 n . Concatonate onto top, and run KRC. 40 minutes 

\vspace{-3.mm} 
\begin{verbatim}
1) first case is flat;                   Out: BenX00_00a00 == BenXflat.tm1
2) All azi slope=30, using flat as far.  Out: BenX30X00a00.tm1 and .t52
3) All azi all slope, oppos 30 as far    Out: BenXssX30azz.tm1 and .t52
4) All azi all slope, oppos = as far     Out:             BenXssXss.t52
\end{verbatim}
  
\section{User Guide to IDL beaming.pro}
Must first have used KRC to generate at least one full tilt-set for the object
of interest; output seasons must span one object year (IDL beaming.pro will wrap
over a gap for the last season), have a uniformly spaced set of slopes and a
complete uniformly spaced set of azimuths starting with 0 (do not include
360). See a KRC input file that does this, such as \nf{BeamA.inp} .

Notation:
\qi The ``\textbf{grid}''  is the set of hours (uniformly spaced) and latitudes (uniformly spaced in area on a sphere) in the KRC model.
\qi A ``\textbf{tilt}'' is a surface dip (uniformly spaced) and azimuth (uniformly spaced) of a surface element at a grid point.
\qi A ``\textbf{KRC tilt-set}'' is a set of KRC output files for global-grid models that all have the same input parameters except for the surface slope and azimuth. Also called a KRC  ``\textbf{run}''.
\qi A ``\textbf{view}'' specifies the direction to the viewer, initially in Hour-Latitude coordinates.

\subsection{Auto-init}
At start-up, \nf{beaming.pro} does:
\vspace{-3.mm} 
\begin{verbatim}
880.. Decomposed=0
851.. black background
860.. set to 14 colors for black background
40... View set by @15 parv
42... Prepare the wave and view vectors
45... Define the resolutions in tilt-set and theory 
256.. DEFINEKRC for current precision
\end{verbatim} 

\subsection{Summany of IDL  data evloution}

\begin{description}  % labeled items 
\item [KRC] Run sequence of Z2.inp, Z3.inp Z4.inp runs to create .t52 files for each run and slope
\qi e.g. \qfo{/work2/beam/BEnA34A00.t52} and \nf{--eq.t52}.
 \qi Single \qfo{BEnAflat.t52} [ packed 5-dim. ]

\item[Compact] @111,123 . Output @257
Convert to single surface temperature file, e.g.
\qi  \qfo{/work2/beam/BenAssA00.savAz} and \nf{--eq.savAz} \nv{y3} is [hour,lat,season,azimuth,slope]
 
\item [Date] Specific date @112,123 . Output @28  e.g., 
\qi \qfo{BenA5906Aeqflat.bin5} and 
 \nf{BenA5906Aeqslop.bin5}  [hour,latitude,1,case=azimuth,file=slope]
\qi  @280  R 0+1+2+ss+4+.t52        t52 set           many
\qi    @28  W 10+11+12+14+4+flat/slop.bin5  t4[hour,lat [,azim,slope]] 
\qi   Up to 40 sec

\item [Radiance] Output @438  e.g., \qfo{BenJ5906w1w.bin5} [wave,azimuth,slope,hour,lat] t
\qi    @29  R == @28W
\qi    @438 W 10+11+12+14+w+5+w.bin5   rrr[wave,azim,slope,lat]  slope[0]=flat, azi replicated


\item[Integration] Loops over roughness and model. Work done @64,  output @1435 
\qi either one surface point \qfo{BenABJKL5906H25L9w1.sav}  [wave,view,Ho,La,rough,run-set]
\qi  or global  \qfo{BenABJKL5906Gw1.sav} 
\\ @430 parses parq and  sets number of tilt-sets sets
\qi    @439 R == @438    loops
\qi   @1435 W  10+11+8+14+9+w+5+.sav   check for unique
\qi    @7  R == @1435


\end{description}

\subsection{Step 0: optional, Plot solar declination over date}

KRC type -n files do not contain the sub-solar latitude for all seasons. 
This is an estimate based on a quadratic fit of the noon down-going insolation versus latitude.

@11, modify parts of file names: 0, 1, 2
\qi @110, 123 which does:
\vspace{-3.mm} 
\begin{verbatim}
207.. Set file names
252.. Open/Read/Close type 52 file
22... Get KRC front and hold
253.. Estimate Sdec at each season and one date
254.. Plot annual sdec and interpolate ttt to date
\end{verbatim}

\subsection{Step 1: Make 2 date files}
See \S \ref{s1} 
\\ @16, modify items 
\qi 7: Length of the target's year in Earth days. Must be same as KRC run
\qi 8: Date desired. (will be rounded to nearest integer day.) 
\qii Must be within the date range in the tilt-set files 
\\ @12,  modify items
\qi 1: Increment between slopes, degrees. Must be same as KRC run
\qi 2: Number of slopes (not including horizontal). Must be no more than KRC run 
\qi 3: Increment between azimuths, degrees. Must be same as KRC run
\\ @11, Check parts of file names: 0, 1, 2, 10, 11, 12
\\ For a \textbf{single} KRC run, do @280, then @28. Or do @111, 123
\\ For \textbf{multiple} runs: @13 to edit run-unique names, then do @141 125 [128] 123
\qii  Will prompt for file names (check and modify as needed) and float values (only item 8 is used)
\qi Output: for each tilt-run: 
\qii Date file for all slopes: parf[14]=dir +parf[5]+parf[6] e.g., BeamA5858.bin5
\qiii Tsurf [hour, latitude, azimuth, slope]
\qii Date file for flat with similar name: e.g., BeamA5858flat.bin5
\qiii Tsurf [hour, latitude]
\\ FLOW: @141
\vspace{-3.mm} 
\begin{verbatim}
     11... Modify any of strings 
     1411. set parf[4] flat
     16... Modify tests
     1232. Start clock 2  
     207.. Set file names
     252.. Open/Read/Close type 52 file 
     253.. Estimate Sdec at each season and one date
/--> 133.. Set run uniq for 2nd loop
| /--> 28...  Read KRC-set, interpolate to one date. Write date file
| \<-- 1256. +++   Inner-loop increment
|     -5... Do nothing quickly
\<--- 1258. +++++ Second-loop increment
     -5... Do nothing quickly
\end{verbatim}  

\subsection{Step 2: Convert to radiance}
See \S \ref{s2}. Required input: A date file pair generated by Step 1
\qi [ @14: check wavelength set]
\qi @11, modify parts of file names:
\qi @29 to read a date file: parf  10+11+12+14+4
\qii The flat temperatures become the first slope and  are replicated for all azimuths
\qi @15, then @40  ; define the views and transfer
\qi @42 Prepare the wavelength and view vectors array 
\qi @43 Nested 4-loop to convert Temperature to radiance
\qi @438 Write a radiance .bin5 file:
\qii File name is: parf[10]+parf[11]+parf[12]+parf[14]+'w'+parf[5]. E.g., /work1/krc/beam/BeamA5858w1.bin5
\\ For \textbf{multiple} runs: @13 to edit run-unique names, then do @142 125 [128] 123

Output:  Radiance file: [wave,azimuth,slope,hour,latitude]
\\ FLOW:
\vspace{-3.mm} 
\begin{verbatim}
     11... Modify any of strings
     14... Modify waves
/-/--> 133.. Set run uniq for 2nd loop
| |    43... Convert t4 to rad  REQ 29 42
| |    438.. Write radiance file REQ 43
| \<-- 1256. +++   Inner-loop increment
|     -5... Do nothing quickly
\<--- 1258. +++++ Second-loop increment
     -5... Do nothing quickly
\end{verbatim} 

\subsection{Step 3: Integration}
Target can be either one point or the sub-viewer hemisphere. Specifed by 3 values:
pari[9:11] 
\qi flag; 0=spot, 1=hemisphere, -1=spot  with nadr view
\qi hour index
\qi latitude index

The shadow function $S$ is computed by the HHIDE routine, which allows any of the azimuth functions $f(\Psi)$ described in \S \ref{azi} . The computed sunlit fraction for a rough surface is applied to all facets.
Radiances for the fraction in shade are set to the minimum diurnal radiance (temperature) for each facet, which is an extreme.

Radiances at night can optionally be adjusted in a similar fashion but the ``sunlit'' fraction is set by the computed shadow function for the rough surface at noon, independent of the view direction, typically a small change. This is mostly a check on possible effects and generally not invoked; as a rough surface will absorb at least as much sunlight as a flat smooth surface (of the same properties) and thus emit MORE radiance at night than a smooth surface.

If a hemisphere, view must be a list; not grid.

View directions can be specified in several ways: 
\begin{description}    % numbered items 
 \item [List] Pairs of hour,latitude sub-viewer points
 \item [Cardinal traverses] Specify the center hour and latitude, the step size in each direction, and the number to each side in both directions
 \item [Diagonal traverse]  specify the center hour and latitude, the step size in each direction, and the number to each side.
 \item [Grid] Specify same as cardinal traverse.
\end{description}
These are all defined by the array \nv{parv}; a consistent algorithm will convert this into a view-pair list is \np{viewgen.pro}


@44 is necessary because of the complex sequence of defining all the geometry. The radiance file must agree in size.

See \S \ref{s3}. Required input: one or more radiance files generated by Step 2.
\qi Check file names @11; [0:3 must be a valid set. e.g., Ben A 30 A00]
\qi Check file names @13; each up to first short must be a valid .t52 set
\qii  In form l*t where full set lsst.t52 must exist in the @11 [0] directory.
\qi Check tilt values @12 items 1,2,3; must agree with KRC run
\qii item 5 sets sets stops at loop ends: \nv{lobt} +1=inner loop +2=mid +4=outer
\qi Check wavelengths @14
\qi If global, check views @15
\qi If local point, check views @16 items 1:6 
\\ Do  @130 and @42 
\\ If locale @143 \  OR \ if global @144.  Then:  @146, 125, [128,] 123

Make an IDL save file [-.sav] 
 
View directions can be specified to any precision. Local view targets are
available only on grid points; interpolation of the results is probably
reasonable.
\\ \textbf{Output}  IDL save file [-.sav] 
%  4-D cube of radiance [waves+1,views,1+roughness, KRCrun]
\qi  name will be  parf[10]+parf[11]+parf[8]+parf[14]+parf[9]+'w'+parf[5]  + .cub
\qiii e.g., /work1/krc/beam/BeamKLA5900H24L9w1.cub
\qii Unique part, parf[8], will be constructed as concatonation of the tilt-set names set @13.
\qii parf[14] is the date, will be the same as for the input files
\qii parf[9] depends upon the style of integration and will be constructed
\qiii  Global views output files will be 'G' 
\qiii Local views will be  e.g., H25L9 =  H + the 0-based hour index + L + the 0-based latitude index.
\\ FLOW:

 @46 defines fpp and rescales parh[5:7] but retains their proportions

\vspace{-3.mm} 
\begin{verbatim}
..====================== beaming ===================..
      ..... start clock4
     11... Modify any of strings
     130.. Parse list of tilt-set names
     439.. Read radiance file
     440.. set systems sizes from radiance cube REQ 439
     45... Define the resolutions in tilt-set and theory 
     6.... Calc Cartesian tilt normals in S system  REQ 45  440
     62... Set target loop limits and creat view list REQ 1 of 25 252 29 439
     42... Prepare the wave and view vectors REQ 15 or 62+622
     48... HIDING  B.G. Smith 1967
     1431. Create storage
     1232. ..... Start clock 2
/--> 1432. Increment theta-bar
|     46... Compute distribution for KRC slopes REQ 29 or 439, 45
|     486.. Normalize the dip function REQ 46 48
|     1231. ..... Start clock 1   inner loop
| /--> 1433. Set run uniq
| |    439.. Read radiance file
| |    44... Ensure sizes the same REQ 252 or 440, 439
| |    64... Integrate roughness REQ  and  46 or 439  486 62
| |    1434. Save into n+2 D arrays
| \<-- 1256. +++++ Inner-loop increment: clock1
|     -5... ......... missing .........
\<--- 1258. ++++++ 2nd-loop increment: clock2
     1435. SAVE integrations

\end{verbatim}

 Then can do @7 to read the cube, which will yield a plot for each tilt-set
\qi and @71, which will plot traverses for all tilt-runs
\subsection{Analysis}
@7 Read a cube
\qi @71  Plot for each tilt-set
\qi @72 Traverse plot for all runs, for the roughest model

% \pagebreak
\section{Algorithm} 

Initially, assume viewer is far away, so use orthographic
projection. Perspective maps are geometrically much more complex and are not
needed unless a spacecraft is within about 20 body radii.

.
\\ All processing is done by IDL \np{beaming.pro}. The ``@'' symbol is an address in a large case statement.

\subsection{Processing step 1; one date \label{s1}} 
Interpolate a KRC tilt-set to a single season: reformat to file of
Tsurf[hour,lat,season,azimuth,slope].  Output 1.3Mb +7.8 kB (flat)
.
\\ Make a date file:
\qi Specify the KRC tilt-set
\qi Specify the date
\qii Loop on files (slopes) in the model set  @280
\qii Read the .t52 file, one slope of [hour,item,latitude,season,case=azimuth]
\qiii Interpolate Tsurf in date;
\qiii Store in $T_S$ array with same order: [hour,latitude,azimuth,slope] 
\qii Write as .bin5 named with the date  @28


\vspace{3mm}
Read all the KRC files and combine at one surface location
\qii First file, single flat case: extract latitude, dates and set some sizes 
\qii Second file, with many cases: extract azimuths and set that size 
\qi Linear iterpolation in date, make  t4= Tsur[hour,lat,case=azi, slope] 
\qi  and: tflat =Tsur[hour,latitude]
\qiii If also using Tatm, will need another dimension (but do not call it t5)
\qi Save as two bin5 files named to include date, 
\qii header contains: latitudes, azimuths, slopes and the single date

\subsection{Processing step 2; convert to radiance \label{s2}} 
Integration must be done in radiance, so convert Brightness-temperatures to radiances
\\ Specify the effective wavelengths [firm code, or revise @14]
\\ Read the date file: @43
\qii If appropriate, reduce hour density to: number of hours $\sim$ 2* Number-latitudes 
\qi Convert to Tsurf to radiances and reorder: [wave, azimuth, slope, hour, latitude] 

\subsubsection{Actions and loops}  %..............................
Use the same actions for all view-sets and targets; single target will have same lower and upper limits for lat and hour loops. 

.
\\ 11... Modify any of strings
\\ 130.. Parse list of tilt-set names
\\ 439.. Read one radiance file  \ [to get sizes  and define \nv{slop3}]
\\ 440.. set systems sizes from radiance cube
\qii  Define the surface latitude and hour grid (based on KRC file)
\\ 45... Define the resolutions in tilt-set and theory
\\ 6.... Calc Cartesian tilt facet normals in S system
\qii Compute normals for each tilt (slope, azimuth) in the S coordinate system: $\qf{NW_S}$
\qii Specify sub-viewer directions as hour and latitude; i.e, in the D system
\\ 62... Set target loop limits and creat view list
\\ 42... Prepare the wave and view vectors
\qii Compute vectors to viewer in D coordinates: $\qf{VQ_D}$
\\ 48... HIDING, Insurance that \nv{parh} fully defined
\pagebreak .
\\ 1431. Create storage
\\ $\Longrightarrow$ 1432.. Increment theta-bar $\overline{\theta}$  LOOP  koop2
\qi 46... Compute distribution for KRC slopes 
\qi 486.. Normalize the dip function 
\qii  Normalized so that $\int_{\theta=0}^\pi F(\theta)p(\theta) \equiv 1 $
\qi $\longrightarrow$  133.. Set run uniq  LOOP koop1
\qii 439.. Read date-radiance file
\qii  44... Ensure sizes the same
\qii  64... Integrate roughness REQ 42 rrr 46 
\qiii Set any shadow or azimuth flags  %\qiii \ddag Compute shadow slope factors
\\ .  \hrulefill Deeper loops within @64 \hrulefill \hspace{3.in}
\qh{0} For each latitude $j$
\qh{3} For every slope and azimuth, find hour index of the minimum temperature % icold[azi,slop]
\qH{3} Store minimum radiance [wave,azi,slope] AND set the nighttime ``shadow'' value 
\qh{1} For every hour $i$
\qh{2} Compute zenith for the grid-point in the D coordinate system: $\qf{ZQ_D}$
\qh{3} For each view $n$, compute the emergence cosine $\mu =\qf{VQ_D} \bullet \qf{ZQ_D}$ for flat surface % cvv[n]
\qH{3} Store store view factors for one grid point for all views % mu4
\qh{2} Check point is visible in at least one view, if so: THEN
\qH{2} Compute rotation matrix to S from D, \trm{SD}.; see \S \ref{geos}   % SDct
\qH{2} and calc unit vector and azimuth to Sun in S system  
\qH{2} Extract radiances for all waves, azimuths and slopes for this grid point % rri=
\qH{2} LOOP for each view $n$ % for n=0,nvu-1 
\qh{3} Rotate viewer positions into S system, $\qf{VQ_S} = \qrm{SD} \star  \qf{VQ_D}$
\qh{4} Compute view azimuth in S system  and $\mu$  and $e$ % aziv[n] & cose & pahr[2]
\qH{4} Compute the weight (projected area,$ \equiv \mu$) and radiance for level surface % cose sws[n] & srs[*,n]
\qH{4} Compute probability $S( \overline{\theta},i,e,\psi)$ of being in sunlight
\qH{4} Zero slope radiance  and weight sums
\qh{3} LOOP for each slope $m$  % for m=0,nslot
\qh{4} If fractional abundance of this slope above test minimum, THEN 
\qH{3} Zero azimuth radiance and weight sums 
\qH{4} LOOP for each azimuth $k$ % for k=0,nazi-1 do
\qh{5} Get the facet normal and azimuth in the S system. Get radiances[wave] % rrz
\qH{5} LOOP for each view $n$
\qh{6} If facet is visible ($\mu'>0$), THEN  
\qH{6} Set radiance as $\mathcal{R}' = S \mathcal{R} + (1-S) \mathcal{R_\mathrm{min}}$ for each $\lambda $
\qH{6} Add to radiance and weight azimuth sum %
\qh{3} Add azimuth sums times slope abundance to slope sums  %
\qh{2} Store slope sums for roughness:  weight and radiance %
\\ . \hrulefill end of @64 \hrulefill \hspace{3.in}
\qi $\longleftarrow$ 1258. \ end of koop1 : Model
\\ $\Longleftarrow$    end of koop2 : roughness
\\ 1435. SAVE  integrations parf[10+[1+8+14+9]+'w'+[5]+'.sav'

\vspace{3mm} Projected obscuration; The dip factor addresses the geologic bias
on the probability of emergence obscuration, but no basis has been developed for
assigning a temperature to the surface causing the hiding; a neutral approach is
to simple not count the contribution of that surface to radiance or area
summation.

\vspace{3mm} NOT YET: Makes sense to use a single atm temperature. Use the Tatm
of all models weighted with the surface abundance based on slope distribution,
not the view factors.

\subsubsection{Step 3 output files} %.........................................
e.g., /work1/krc/beam/BenABJKL5906H25L9w1.sav
\qi Target location indices are in file name: hour[25]=13. lat[9]=0. 

Last geometry fix  2018 Sep 23 08:00:00 , any prior are suspect.
 
For globe. 2 rough * 5 models = 10 loops takes 1.1 minutes
Sved items are shown in Table \ref{rsave}

\begin{table} \caption[Roungness integration output]{File saved after integration ovr facets for roughness. Shown here for global runs; single targets are missing the Hour and Lat dimensions }  \label{rsave}
\begin{tabbing} 
WWWW \= WWWW \=WWWWWWWW \=   \kill 
     \>     \> typical \>  \\
name \> type \> dimension \> \hspace{2.cm} Description \\
NPQ   \>  LONG   \>      5       \>  Number of KRC run-sets (models) \\
HARR \>   FLOAT  \> [12] \> \nv{parr}  control parameters  \\
HARQ \>   STRING \> [9] \>  \nv{parq}  control parameters \\
HARV \>   FLOAT  \> [12] \> \nv{parv}  view pairs or control parameters\\ 
SRO  \>   STRING \> [2] \> roughness $\overline{\theta } $\\ 
WAVET  \> FLOAT  \> [9] \> Wavenumbers \\
AVRS4  \> FLOAT \>  [9,48,19,5] \> Radiance  $\mathcal{R}$ for smooth surface [wave, hour, lat, model] \\
\> \> \> direct from date-radiance cube \\
WEIS4 \>  FLOAT \>  [18,48,19,5] \> weight $=\mu $ [view, hour, lat, model:redundant]  \\
AVRR4 \>  FLOAT  \> [9,18,48,19,2,5] \> $\sum P(s,\overline{\theta}) \mu \mathcal{R}$ [wave, view, hour, lat, roughness, model] \\
WEIR4 \>  FLOAT  \> [18,48,19,2,5] \> $\sum P(s,\overline{\theta}) \mu$ [view, hour, lat, roughness, model:redundant]  \\
\end{tabbing}
\vspace{-5.mm}
\hrulefill \end{table} 

\subsection{2018sep20 redesign concept (not coded)}

 Could increase the Nhours to 96 with little penalty. Increase nlat to 37 would double the KRC run times.

If stay with 48,19, then remove use of .t52 for airless bodies. Compile version of KRC with the fixed sizes tailored for large asteroid runs. Everthing after the date file remains the same.

\subsection{integration}
symbols and indices:
\qi wave: W l, usually *
\qi azimuth: a k 
\qi slope: s m
\qi view:  V n
\qi KRC model: M koop
\qi roughness: B (theta-Bar) koop
\qi hour: H
\qi latitude: L

Start with radiance array (W,a,s,H,L,M)

Output radiance array (W,V,B,H,L,M) or (W,H,L,M,V,B)  and weight array without W or B
\qi For point target, H and L are 1
\qi For global target H=nhour(48) and L=nlat(19)
\qii Then can do summation for an unresolved object

B 
\begin{verbatim}
uild R((W,a,s,H,L,M)
Find index of minimum R at longest wave (a,s,H,L,M]
Precompute slope proportions for each roughness
Calc index of max significant slope for each roughness
Loop on latitude
Loop on Hour
Calc $/mu$ for horizontal surface, for all views. if any visible then:
   transfer R(w,a,s,M) and R_min(w,a,s,M)
Loop on views, if $/mu>0$ then
Loop on slope (max depends on roughness)
Get proportion for this slope (roughness)
Loop on azimuth
  Calc $/mu$ for the facet, if visible then:
Loop on roughness B
  Calc shadowing S 
  sum (1-S)R + SR_min  [w,M,B]
Store SumR(W,H,L,M,B,V) and store $/mu$(H,L,B?,V)
\end{verbatim} 

Sum $/mu$ R for each view to get spectrum of unresolved body

\subsection{Analysis}

 if local do @62, if global do @63, then 7,... 71

\subsubsection{Narrowing of data size, and file naming}
A typical set of KRC type 52 files generated for beaming is 774 Mb [Ts
  only]. Constructing a set of Tsurf files for one date, @280, yields
t4=[hour,[Ts/Ta],lat,case=azimuth, slope] and a file for the flat case, total
1.32Mb. 
 
\begin{verbatim}
OBSOLETE ??

first run of 4 views without cos i test Elapsed time1=        2.4648681
  with  1.28600

at !dbug=2 can see that model temperatures have some irregularity.
QLAT=-6.04000 QHOUR=4.50000  mostly about 0.3K , at max slope, max of 1 k
\end{verbatim}

.
\\ BeamXii.t52 \ Tilt runs: where X is a run letter and ii is the slope in degrees
\qi Contains a case for each azimuth
\\ BeamXnnnn.bin5 \ Date files: where nnnn is the modified julian day
\qi 48 19 18 20  [hour,latitude,case=azimuth,file=slope]  Real*4
\\ BeamXnnnnflat.bin5  \ Date file for horizontal surface:
\qi 48 19 Ts[hour,latitude]   Real*8
\\ BeamXnnnnQii .bin5  \ Ts for a single point (latitude and Hour) at a specific date.
\qi 18 21 Ts[azimuth,[flat,slope]]
\\ BeamK5858w1.bin5 radiance file specific run=K, specific date=5858 wavelength set 1
\qi 11 18 21 48 19 [wavelength,hour,latitude,case=azimuth,file=slope]

\vspace{2mm} .
\\ KLA5858H25P9w1.cub   4-D radiance cube
\qi 12 21 4 3  [waves+1,views,1+roughness, krcRun]
\qiii Header contains wavelengths and views
\qii Last waves is the weighting divisor
\qii First roughness is the smooth (all flat) model
\\ KLA5858H25P9w1.sav  /  same as above .cub:  @1325
\qi saving:  avrr4,weir4,avrs4,weis4,vuin,sro,wavet
\\ KLA5858w1.cub   Early radiance cube
\qi 12 4 4 3
\\ KLA5858w1.sav 
\qi same as above, saving:  avrr4,weir4,avrs4,weis4,vuin,sro,wavet

\subsubsection{Sdec}
Solar declination is not in the type 52 file. Can estimate it for each season by
fitting the down-going Visible radiation at noon as a function of latitude, and
finding the maximum. Typical result is shown in Figure \ref{beam251}
\begin{figure}[!ht] \igq{beam251}
\caption[Estimated sub-Solar Latitude]{Sub-solar latitude derived from the
  down-going visible radiation as a function of latitude.
\label{beam251}  beam251.png }
\end{figure} 
% how made: beaming @251

\section{Bennu and OSIRIS-Rex}  % ---------------------------------------------

\qcite{Emery14}
\qi bulk thermal inertia of 310 $\pm$ 70 \quti
\qi use visible geometric albedo  0.046  $\pm$0.005
\qii 23.2a: $p_v = ( D_o/ D_{eff})^2 10^{-0.4H_v}$  \ \ $D_o$ taken as 1329 km \ \ $H_v$ =20.51 $\pm$0.10
\qii $ D_{eff}$ about 600 m; Table 5
\qii yields $p_v=$ 0.0306723
\qi The Bond albedo is calculated as $A_B = p_v q$ 
\qii p 23.0b,  $q$ is the phase integral (0.367 ± 0.045),
\qii yields $A_B =$  0.0112568
\\ .
\\ \qcite{Chesley14}
\qi bulk density at 1260 $\pm$ 70 kg/m$^3$ and macroporosity 40 $\pm$ 10\%.

Bennu year is 436.42 days.  Beam runs are 41 seasons spaced by 10.9106 days,
5764.2720 to 6200.6960; 

\vspace{2.mm} OSIRIS-Rex: Arrival is 2018 august, [aug03 is MJD 6789, handy],
Survey begins 2018Oct, Return window opens 2021march, Earth landing is
2023sept24. Thus, spacecraft is near Bennu for a little more than 2 of its
years. MJD of the first three events is: 6787, 6848, 7730.
\qi Equivalent dates:  5914.15, 5975.15 and 5984.31, respectively.
\qi Solar declination: 33 N, 22 N, 18 N 
\\ In the KRC runs, Extreme seasons are:
\vspace{-3.mm} 
\begin{verbatim}
Ls=0:    index=39, djmm=6189.8, sdec= +0.65    runset 6190
   N:    index=12, djmm=5895.2, sdec= 33.16    runset 5900
Ls=180:  index=24, djmm=6026.1, sdec= -2.79 
     S:  index=30, djmm=6091.6, sdec=-33.07    runset 6092
\end{verbatim} 

2016oct12, Looked through \qcite{} and used orbital and rotational parmeters to
make an additional entry in NEO.tab; also found Bond Albedo = 0.0173 +/-.0027
(1-sigma).

\subsubsection{Pole}

In -/porb/small.tab, as the 6'th object: 
\vspace{-3.mm} 
\begin{verbatim}
101955 Bennu 2455562.5   /6   from Hergenrother 2014
e       0.2037451146135014      2.123081E-08    J2000 orbital values 
a 	1.126391025571644       4.111300E-11	AU    source cited as 
q 	0.8968943569669300      2.390158E-08 	AU    JPL IOM 343R-13-00
i 	6.03493867976381        4.721372E-08	deg   Chesley et al 2014
node 	2.06086819910204        6.531279E-08	deg    
peri    66.22306886293201       9.685025E-08	deg
M 	101.70394725713800      2.6E-06 	deg  P=436.648727924 days
rot_per 4.297461   ± 0.002 h, retrog. Nolan et al 2013.  JPL has  4.288 h 
PoleRA  86.64   Nolan 2013 : β = −88° (lat), λ = 45° and an uncertainty of 5°.  
PoleDec -65.11    in ecliptic coordinates,  Convert using eclip2equat.pro 
merid   0.         Obliq=176 +/- 2
\end{verbatim}

% after lon/lat switch correction, equatorial pole values agree with conversion using NED: NASA/IPAC EXTRAGALACTIC DATABASE, to $,.0001$ degree.

\subsection{Retrograde rotation}  % ----------
On Bennu, the Sun rises in the celestial west. PORB does everything in J2000 (equatorial).  All of the time-independent terms are in the geometry matrix computed by the PORB system, see \nf{hporb.pdf} . 
KRC is indifferent to this, treating ``North'' as the direction of the spin axis.

Summary of KRC geometry:

The right-hand spin-axis direction is: 
\qi ZBAA ! 10 Body pole: declination, radian in J2000 eq.
\qi ZBAB ! 11 " ": Right Ascension, radian in J2000 eq.
\qi WDOT ! 12 Siderial rotation rate, degrees/day

Position along the orbit is based on:
\qi OPERIOD ! 14 Period of the orbit (days)
\qi TJP ! 15 J2000 Date of perihelion

The BFRM(9) ! 22 Rotation matrix from orbital to seasonal:
\qi F is the Focal=orbital-plane system.
\qii Z axis of the F system is the right-hand normal to the orbital plane
\qii X axis is from the central body to the orbit periapsis
\qi B is Body=seasonal system
\qii Z axis of the B system is the right-hand spin axis of the body e.g., planet
\qii X axis is the body’s Vernal equinox: 

TSEAS calls PORBIT with the date to get:
\qi SUBS, season longitude (not used)
\qi SDEC, sub-solar latitude, degree
\qi DAU, distance from Sun in Astronomic Units. 

TLATS works in the ``Day'' coordinate system: 
\qii Z axis toward planet north pole
\qii  X axis in equitorial plane toward midnight 
\qi DIP is the slope angle, radian
\qi SAZ is the azimuth of the dip (down-slope), measured East-ward from North, radian
\\ In this system, several vectors are fixed:
\qi MXX is the vector to the Sun at midnight, so the Y element is always 0.
\qi FXX is the vector to the regional zenith at noon,  Y element is always 0.
\qi TXX is the vector toward the tilted surface normal at noon.

At each time step, the vector to the Sun HXX is computed by a single rotation of
MXX around Z by -J*RANG where J is the time step and RANG is $2 \pi / N_2$ where
$N_2$ is the number of time-steps in a day. The cosine of the incidence angle
onto the flat and tilted surfaces are just dot products; HXX $\bullet$ FXX and 
 HXX $\bullet$ TXX respectively. 

An example of the azimuth dependence of Tsurf is shown in Fig. 
\ref{azex}
\begin{figure}[!ht] \igq{azex}
\caption[Example of azimuth set]{Surface kinetic temperatures at all azimuths (legend) for the L set for slope 30\qd~ at the equator for MJD=6200.7, $L_s$=189 
\label{azex}  azex.png  }
\end{figure} 
% how made: Read  file: /work1/krc/beam/BenL30L00.t52  tes=reform(ttt[*,0,9,40,*])
% jj=string(20*indgen(18), form='(i3)')
%  CLOT,tes,jj, tsiz=2., titl=['hour index','Surface temperature','L30 , lat 9, seas 40'],locc=[.1,.93,-.03,.03]

\subsection{Production Runs}  % ----------
KRC input files are generated with assisteance of the IDL routine  krcindgen.pro

Must first construct a beaming master input file such as \nf{Bentop}, which must
have a trailing blank line. Then for each production run, modify the change
lines that define the albedo, inertqia, photometric function (PhotFunc), etc for
a specific Lettered run.

Create the directory   /work1/krc/beam/BenX/ for Bennu and Letter X

Run krcindgen for style 2 for the specific Letter, here shown as X, this will generate cases for both Run 1 and Run 2
\qi cat Bentop  inpgen.inp > X2.inp
\qi the run KRC with X2.inp . Takes about 70 sec

Run krcindgen for style 3 for the specific Letter and concatonate:
\qi cat Bentop  inpgen.inp > X3.inp
\qi then run KRC with X3.inp  Takes about 2800 sec

Run krcindgen for style 3 for the specific Letter, modifying some fields
\qii 2: X4
\qii 8: Aeq
\qii 17: = 
\qii 18: a30
\qii 21: no
\qi  cat Bentop  inpgen.inp > X4.inp
\qi then run KRC with X4.inp  Takes about 2400 sec

\begin{description}  % labeled items  
 \item [Run 1] is a flat case with no farIn, Outputs:  BenX00_00.t52 and /BenX/Xflat.tm1'
 \item [Run 2] uses flat.tm1 from Run1 as farIn, runs for slope=30 and all azimuths. 
Outputs a .tm1 for each azimuth: /BenA/X02a30a00.tm1' etc and BenX30A00.t52
for all azimuths

 \item [Run 3] Runs all slopes and azimuths. Uses the 30\qd~ slope at opposite
   azimuth for the farIn. Outputs a .tm1 for each azimuth and slope:
   BenX/02a30a02.tm1 etrc and a /BenX02A00.t52 etc for each slope.

 \item [Run 4] Runs all slopes and azimuths. Uses the same slope at opposite
   azimuth for the farIn.  Outputs a BenA02Aeq.t52 etc for each slope.
 \end{description}

\begin{table} [!h]
\caption{KRC tilt-set runs. All have: EMISS=1., RLAY=1.15, FLAY=.12, N1=37.; for which the bottom is at  D=121.7 or 1.5048m }
\label{runt}
\begin{center}
\begin{tabular}{| c  r  r  c c | c | r | } \hline \hline
Label & Albedo & Inertia & Photom. & Obl. & Other conditions & run time\\
       &       &        & Function &  &  & seconds\\  \hline
A & .10 & 100 & Kheim & H & yup & I=50 2373 \\ 
A & .10 & 100 & Kheim & L & yup &  1994 \\ 
B & .03 &  50 & Lambert & H & yup  & 2386 \\   % 1
B & .03 &  50 & Lambert & L & yup  & 1903 \\   
C & .03 & 400 & Kheim & L & yup & 2062 \\  % 2018sep27 06:00
J & .03 &  50 & Kheim & H & yup & 2480 \\ 
K & .03 & 100 & Kheim & H & yup & 2474 \\ 
I & .03 & 200 & Kheim & H & &  2490 \\ 
D & .03 & 100 & Kheim & H & I=600 below D=.3 & \\
D & .03 & 100 & Kheim & L & I=1600 below 5 mm & 1721 \\
P & .03 & 100 & Kheim & H & far-field is slope=30 at azimuth+180 & 2458 \\ 
 \hline
\end{tabular} \end{center}
\end{table}
\vspace{-3.mm} 
\begin{verbatim}

2018 Sep  4 16:46:00  A=.03  I= 50.  PhoF=0.  BenB2.prt
2018 Sep  5 23:37:18  A=.03  I= 50.  PhoF=0.  B3.prt
2018 Sep  5 23:53:09  A=.03  I= 50.  PhoF=0.  B3b.prt
2018 Sep  6 12:21:30  A=.03  I= 50.  PhoF=0.  B3c.prt
2018 Sep  6 17:33:13  A=.03  I= 50.  PhoF=0.  BenB1.prt
2018 Sep  9 13:27:21  A=.03  I= 50.  PhoF=0.  BenL2.prt
2018 Sep  9 17:52:55  A=.03  I= 50.  PhoF=0.  L2.prt far=30=L3.prt DELETED    
2018 Sep  9 18:01:45  A=.03  I= 50.  PhoF=0. 
2018 Sep  9 21:18:08  A=.03  I=100   PF=0.25  K2.prt far=30=K3
2018 Sep  9 21:18:08  A=.03  I= 50   PF=0.25  J2.prt far=30=J3
                      A=.03  I=100   PF=0.25  A2.prt A3 A4
\end{verbatim}
 Start with basic model representative of asteroids using a nominal orbit and
 spin axis (e.g., Bennu). Offset individually various model parameters to
 generate partial derivatives.

 All runs have a flat model used for the far field and a set of slopes spaced a
 2 degrees up to 60 \qd, with 18 azimuths spaced by 20\qd. Runs have 40 seasons
 with a 3-yr spinup and use 19 latitudes centered in equal-area zones. Runs use
 N1= 37 layers with the first physical layer having a thickness of FLAY= 0.12
 the diurnal skin depth (D) and the thickness ratio of successive layers being
 RLAY= 1.15 , Using number of output hours N24= 48 and number of latitudes N4=
 19 yields an hour density 1.26 that of latitude, so areas in the hour-latitude
 grid are close to equant.  Input parameters are largely Version 3.3 default
 values except as listed in Table \ref{runt}. Output 30 files of 38.6Mb each and
 one flat of 2.1Mb for a total of 1.16GB for one tilt-set. One run takes about
 40 minutes (0.77GB and 27 minutes if go only to 40 \qd~ slope).

Tilt-set runs to date have files for each slope labeled BeamXNN.t52 where X is
are run Label (see Table \ref{runt}) and XX is the slope, XX=00 is the flat
file.

BEAMING @111 123 will read all the slope .t52 file for a run, convert them to a
single save file of 81MB containing the surface temperature and one KRC common,
reducing the size by a factor of 14. It also prompts to move the .t52 files to a
``dormant'' directory, which could later be deleted.  
\qi @11: check 1, 2=Z 3=Z00 or Zeq

\section{Mysteries}
\subsection{midday glitch in rough radiance}
BEAMCK @ 71:  midday low is in all rough, model and view
\qi @73  bad hour index is 23 for lat index 0:9   lat 15:16 are negative!

FOund that BEAMING @64 was using shortest wavelength to assess coldest time, which  do poorly for cool targets. 


New test: @12 13=31, 9=1 ??,  @13 1=q,    @16 9=30 
130 42  143  125 123 no changes


2018 Oct 2 15:53:58  HIDING with item2 =-3, at stop, sss and hhh are different, 
\qi delta HIDE2=     0.128426    0.0102457   Some HIDE2 negative!
\\ However, BEAMING @485 run twice shows HIDING and HIDE2  identical results

store fsun,
 histfast,fsu3
 out=quilt3(fsu3>(-.5),['hour','lat','view'],grid=153,prt=3,/mod3,mag=5)
 see midday glitch, average is near zero!, should be bunch near 1.

stereograph,hqsxxu,'HQS'  
stereograph,vqsxxu,'v'+stid,/oplot  Shows V17 close to Sun
\subsection{.t52 size}

\begin{verbatim}

[hkieffer@hulk3 beam]$ lt 00_00.t52
-rwxr--r-- 1 hkieffer  2145536 Sep  9 17:53 BenL00_00.t52*
-rwxr--r-- 1 hkieffer  2145536 Sep  9 21:18 BenK00_00.t52*
-rwxr--r-- 1 hkieffer  4290560 Sep 10 05:59 BenA00_00.t52*
-rwxr--r-- 1 hkieffer  4290560 Sep 12 13:02 BenJ00_00.t52*
-rwxr--r-- 1 hkieffer  2145536 Sep 12 22:42 BEnA00_00.t52*
bhead BenLflat.t52
 5 48 7 19 42 1 5 268128 512  <<SIZE  2018 Sep  9 14:48:36  >>  KRCv3.5.6
 bhead BenA00_00.t52
 5 48 7 19 42 2 5 536256 512  <<SIZE  2018 Sep 10 05:59:56  >>  KRCv3.5.6
[hkieffer@hulk3 beam]$ bhead BenJ00_00.t52
 5 48 7 19 42 1 5 268128 512  <<SIZE  2018 Sep 12 13:02:42  >>  KRCv3.5.6

read with READKREC52:
Will Read  file: /work1/krc/beam/BenJ00_00.t52 Size=  5 48 7 19 42 1 5 268128

Will Read  file: /work1/krc/beam/BenA00_00.t52 Size=  5 48 7 19 42 2 5 536256
  but % READKRCCOM: Unexpected IDX
\end{verbatim}  
 A2.inp had a blank line after: ---- Last line before inpgen file,followed by blank line

\subsection{Step 3 and 4 KRC run times}
Run 30\% faster Sept 16 and later, perhaps due to low obliquity
\begin{verbatim}
 441944 Sep  6 12:59 B3c.prt  2233.757
 441944 Sep  9 18:39 L3.prt   2237.317 
 441944 Sep  9 22:05 K3.prt   2311.958
 448926 Sep 12 13:48 J3.prt   2321.201
 448980 Sep 12 17:54 A3.prt   2315.919
 441998 Sep 16 06:02 EA3.prt  1925.268
 442052 Sep 26 12:09 EB3.prt  1902.696
\end{verbatim}  

\section{OSIRIS-Rex geometry}
Phil via Chris Haberle provided  ``image table from JAsteroid.`` file for 
 days of OTES approach observations; these had entries every 2 seconds so were huge and fantastically redundant. The simple linux command  
\\  grep '00:00.' OTES_WOY45_Approach_DOY309.txt > OTES309hour.txt reduced the tables to one entry per hour
% \\ grep '?0:00.'  OTES_WOY45_Approach_DOY309.txt > OTES309tm.txt
\qi  '00:01.' for DOY307, which had odd seconds
\qi then: \ \  cat OTES307hour.txt  OTES309hour.txt OTES313hour.txt > ApGeom.tab
\qii and edit in the column heareds with no internal white-space.




% \pagebreak
\bibliography{heat,moon,mars}   %>>>> bibliography data
\bibliographystyle{plain}   % alpha  abbrev 

 %=============================================================================
\appendix %====================================================================
 %=============================================================================

\section{Shadow hiding: HIDING, HIDE2 and HHIDE}

HIDING and HIDE2 use parh 1:9 in BEAMING.  HHIDE is a later version with less code and slightly faster and has individual arguments

HIDING: parr[2] determines action:
 \qi 0+: computes single value for function
\qi -1: plot S(theta) of mu/w
\qi -2:  plot Phi
\qi else: Reproduce Smith 67 Fig 2. 

\vspace{-3.mm} 
\begin{verbatim}
HIDING parr                                           Reset in beaming
       0      1.00000  edit this
       1      33.0000  RMS slope, degree
       2      20.0000  incidence angle, degree -=Figs   @64
       3      45.0000  emergence ang. deg.              @64
       4      22.0000  Facet dip, deg -=ignore
       5      1.00000  dip c0 \ Normalized so that
       6     0.100000  dip c1 | Integral F(dip)p(dip)
       7     0.100000  dip c2 / over 0:pi/2 is unity
       8      90.0000  relative azimuth, deg.           @64
       9      0.00000  Azimuth type: 0=Hapke 1=cos
      10      35.0000  Num I angles   INT
      11      2.00000  delta incidence
      12      10.0000  Num dip angles   INT
      13      4.00000  delta dip angle

\end{verbatim} 


\section{KRCINPGEN: generate a KRC run set}
KRCINPGEN is designed to construct large Beaming run change lines, however, all
the ``fixed'' parts of these lines are in a array that could be modified. Also,
there is some flexability of the things which change between cases. It has 3
control arguments, all are input and output and will be created with default
values if short:
\qi 1: \nv{park} \ intarr(6) \ Slope and azimuth ranges. 
\qi 2: \nv{pars} \  strarr(29) \ Parts of the script construction, and flags
\qi 3: \nv{ii} \    intarr(?) \  Indices in \nv{pars} of allowed changes.

The last 2 items in \nv{pars} control access to the ``fixed'' parts.
\qi [last-1]: set 'y' or 'Y' to access the ``fixed'' strings 
\qi [last]: set 'y' or 'Y' to modify the spacing or number of azimuths and slopes.

Default vales are shown below. User must be careful to change enough names so
that prior run files are not duplicated, because KRC does not check and will
overwrite existing files with no warning or record!

\vspace{-3.mm} 
\begin{verbatim}
pars: Gener. parts
  0 DIR: files  AAA = /work1/krc/beam/
  1  " .inp         = ~/krc/tes/
  2 name [.inp]     = B3
  3 Slope cmd       =  1 23 
  4  " mid          = . 'SLOPE' / 
  5  " note         = -------------
  6 t52 cmd         =  8  5 0 '
  7 t52 X           = BenB
  8 t52 x           = B00
  9  " .ext         = .t52' / t52 out all azim
 10 Azimu cmd       =  1 24 
 11  " mid          = . 'SLOAZI' / 
 12  " note         = ---
 13 In flag y/n     = y
 14 FarIn cmd       =  8  3 0 '
 15  fin X          = BenB/
 16  fin x          = B
 17  fin ss         = 30
 18  fin Fff        = B00
 19  " sep          = a
 20  " .ext         = .tm1' / farIn
 21 Out flag y/n    = y
 22 FarOut cmd      =  8 21 0 '
 23  fout X         = BenB/
 24  fout x         = B
 25  fout Fff       = UUU
 26  " .ext         = .tm1' / farOut ala K4OUT
 27 ModRange y/n    = y
 28 Mod All y/n     = y

if 28 [13] is n, will see only the following:
pars: Gener. parts
  0 name [.inp]  = B3
  1 t52 X        = BenB
  2 t52 x        = B00
  3 In flag y/n  = y        If n, no input far-field lines
  4  fin X       = BenB/
  5  fin x       = B
  6  fin ss      = 30
  7  fin Fff     = B00
  8 Out flag y/n = y        If n, no output far-field lines
  9  fout X      = BenB/
 10  fout x      = B
 11  fout Fff    = UUU
 12 ModRange y/n = y
 13 Mod All y/n  = y

if 27 [12] is n, will not see the following:
park:  .inp set Ints
  Limits=       0     360
       0       2  Slope: first
       1      60   " last
       2       2   " delta
       3       0  Azimu: first
       4     340   " last
       5      20   " delta
\end{verbatim}

\section{Parameters}
Leading '-' indicates value that must agree with a KRC model set. A leading '+' indicates a value that is required for the minimum full run.
\vspace{-3.mm} 
\begin{verbatim}

@11 parf: File names
+ 0 DIR for krc beam set            = /work1/krc/beam/
+ 1  stem " "                       = Ben
  2   run unique                    = B
  3  " slope part                   = 30
  4  " far part [.t52]              = B00
  5 waveset number                  = 1
  6 Surface site, start with letter = Q1
  7 Comparison stem + uniq          = BeamBen
  8 CubUniq [constructed]           = KLA
  9 Surface point [constructed]     = G
 10 Output dir    \ any "=" will    = /work1/krc/beam/
 11  "    stem    | be reset        = Ben
 12  " run unique / to item 0 to 2  = B
 13 spare                           = ---
 14 mjd [auto][.bin5]               = 6038


@12 pari: Integer values
       0       0  set komit
 -     1       2  slope increment, degrees
 -     2      30  Number of slopes
 -     3      20  Azimuth increment, degrees
 -     4      48  Number of hours output
       5       6  STOP after: +1=seq +2=loop1 +4=loop2
       6       7  KRCCOMLAB:+1=real +2=int +4=log
       7     -77  spare
       8     -77  spare
       9     -77  spare
      10      25  Hour index ->ihour, set to ihot
      11       9  single Lat index ->jlat, set to jeq
      12      31  Index of season near Ls=0

@13 Tilt sets        Number adjustable
   0   K
   1   L
   2   A

@14 wavin: Wavelengths          Number adjustable
+      0      3.00000  \  Wavelengths
       1      5.00000   | in micrometers.
       2      8.00000   | First non-positive
       3      11.0000   | value terminates
       4      15.0000   | the list.
       5      20.0000   |
       6      25.0000   |
       7      50.0000   |
       8      100.000   |
       9     -1.00000  /

@15 parv: Views                  
+      0      12.0000  Hour  1\  Sub-viewer
+      1      0.00000   Lat. 1 | Latitude
       2      3.00000  Hour  2 | and hour
       3      0.00000   Lat. 2 | in pairs.
       4      5.00000  Hour  3 | First negative
       5      89.0000   Lat. 3 | Hour terminates
       6      13.0000  Hour  4 | the list.
       7      90.0000   Lat. 4 | 
       8     -1.00000  Hour  5 | 
       9      0.00000   Lat. 5 | 
      10     -1.00000  Hour  6 | 
      11      0.00000   Lat. 6/

@16 parr: Float values 
       0     0.100000  del Degree in model @45
       1      13.0000  View E/W central hour
       2      15.0000   " " del deg @401
       3      0.00000   " " Number to each side  INT
       4      5.00000   "  N/S central lat
       5      15.0000   " " del deg @402
       6      5.00000   " " Number to each side  INT
-      7      436.423  Length of a year
+      8      5858.00  Target MJD
+      9      5.00000  theta-bar, deg
+     10      10.0000   " " delta
+     11      33.0000   " " maximum
\end{verbatim}  

\section{Sequences for Steps}
\vspace{-3.mm} 
\begin{verbatim}
At start:.
850, 850, 860    Set colors
40... View set by @15 parv
42... Prepare the wave and view vectors REQ 40 or 62+622
45... Define the resolutions in tilt-set and theory 
256.. DEFINEKRC for current precision 

@111 is
207.. set file names
25... Read a slope model set
22... Get KRC front and hold   23: Print krccom
27... Clot [hour,lat] season 20, solazi=0
-1... pause
272.. Clot [hour,case] season 20, lat=0
-1... pause
28... BIN5 W t4=1season

                  Process beaming runs to date files:

Step 1: Generate a date file
16... Modify file names
25... Read a slope model set, interpolate to one date.
28... BIN5 W t4=1season

Step 2: Process date files to fluxes
11... Modify file names
29... BIN5 R t4 = 1 season
43... Convert t4 to rad  REQ 29 42
438.. Write radiance file REQ 43

\end{verbatim}
 Step 3; see \S \ref{s3}

%\clearpage %__________________________________________________________

\section{Testing sep 8}
\vspace{-3.mm} 
\begin{verbatim}
       9      15.0000  theta-bar, deg
normal, store zz0
Tcon    store zz1
beaming Enter selection: 99=help 0=stop 123=auto> 69
Radiance out/in: mean. StDev=     0.123866     0.000622767

theta-bar=2 store zz2  Radiance out/in: mean. StDev=     0.123866   0.000622767
\end{verbatim} 
After scaling, radiance spectrum is shown in 
\ref{beamKa}
\begin{figure}[!ht] \igq{beamKa}
\caption[First try]{Brightness temperature spectra after emperical scaling.
\label{beamKa} beamKa.png  }
\end{figure} 
% how made: 


run with theta=2, fpp=  0.129009     0.558479     0.271261    0.0392474   0.00196731  3.55481e-05  2.34593e-07 ...

after scaling: Fig.
\ref{beamK2}
\begin{figure}[!ht] \igq{beamK2}
\caption[nill slope]{Tb spectra after scaling; $\theta=2^\circ$
\label{beamK2}  beamK2.png  }
\end{figure} 
% how made: 

hemi flat.  11 207 252 

16 9=10 46 

theta-bar=       7.8983530
\\ High slopes not covered=  0.000200987
\\ @64 651 66
\\ Fig. \ref{beamKp}
\begin{figure}[!ht] \igq{beamKp}
\caption[Two slopes]{Tb spectra for two roughnesses, $\theta = 10^\circ$ and 15\qd. KRC model set BeamK, four view directions as indicted in the legend.
\label{beamKp}  beamKp.png  }
\end{figure} 
% how made: beaming.pro, @113 123 66

 \qcite{Rozitis11} values in Table 2: DAU=1., SOLCON=1360, obliquity=0, Period=2551440/86400.=29.5306, Alb=1. EMIS=.9, INERTIA=50

For a circular pit, the slope distribution :
\qbn  p(\theta) =\frac{\sin x \ \cos x}{ \int_{x=0}^{\theta_\mathrm{max}} \sin x \ \cos x \ dx}  \qen

\qbn  p(\theta) \frac{\sin x \ \cos x} {\sin^2x_m/2} \qen

$\sin x$ comes from the circumference at angle $x$ and  $\cos x$ comes from the projection onto the horizontal plane.

\section{Testing sep 13}

Check Fig. \ref{beam5q}, 
\begin{figure}[!ht] \igq{beam5q}
\caption[Ts vrs azimuth]{Debug: BeamA 6200 lat=-6.04000 H= 6.50000 jh,jl= 6 8 .
  The reversal at low azimuth is where the Sun has not risen, but T's are higher
  due to late afternoon heating the prior day.
\label{beam5q}  beam5q.png }
\end{figure} 
% how made: 

\begin{verbatim}
 rotprt,sdrm,/help
9-vector Rotation matrix:  
   0.258819  -0.000000  -0.965926  0 3 6  x-- axis      x  y  z  axis
  -0.965926   0.000000  -0.258819  1 4 7  y-- of new    |  |  | of old
   0.000000   1.000000  -0.000000  2 5 8  z-- in old    |  |  | in new

 rotprt,sdct,/help
9-vector Rotation matrix:  
   0.258819  -0.965926   0.000000  0 3 6  x-- axis      x  y  z  axis
  -0.000000   0.000000   1.000000  1 4 7  y-- of new    |  |  | of old
  -0.965926  -0.258819  -0.000000  2 5 8  z-- in old    |  |  | in new


Expect      
 .2   -.9   0    
   0    0   1 
 -.9  -.2   0

\end{verbatim} 

%\clearpage %__________________________________________________________

\section{Testing 2016 sep 22}
 Indices in @64 loops i=hour, j=latitude, k=azimuth, m=slope, n=view.
 Use l=wavelength

.
\qi theta-bar=       3.9793773 High slopes not covered= -1.19209e-07
\qi theta-bar=       11.698571 High slopes not covered=    0.0216545
\qi theta-bar=       18.716082 High slopes not covered=     0.236797

write  file: /work1/krc/beam/KLA5858H24L9w1.cub Size=  4 12 4 4 3 4 576

Effect of roughness for run K is shown in Figure \ref{KLA7}; the other runs are
similar, as shone in Figure \ref{KLAx}.

WARNING: My intuition is that the E/W profile would show more effect than N/S;
will check any literature examples.

With date 6090, near equinox, hour profile even weaker compared to N/S,
 so something must be wrong. must have incorrect rotation matrix.

\begin{figure}[!ht] \igq{KLA7}
\caption[Effect of roughness]{Effect of roughness on the flux spectrum for
  tilt-set K. Abcissa is wavelength (most rapid index) and view dierection, each
  is labeled near the bottom of the Figure; left side is profile in HOur and
  right side is profile in Latitude. Ordinate is flux normalized to tht at the
  center of the profile (the surface zenith, 6'th set from the left). The smooth
  model (zero roughness) is unity throughout, as expected. the effect of
  roughness increases toward short wavelength in all cases. Tilt-sets L and A
  are similar.
\label{KLA7} KLA7.png  }
\end{figure} 
% how made: beaming.pro 130, 7 

\begin{figure}[!ht] \igq{KLAx}
\caption[Flux profiles]{Profiles of flux excess for grid point Hour=12,
  Latitude=0. at date 5858. Left side is viewer traverse in hour, from 7 to 17,
  and is magnified by a factor of 10; the variation is about $\pm 4$\%.  Right
  side is viewer traverse in latitude from 75 S to 75 N. showing flux variation,
  normalized to viewing from the zenith, show almost 40\% variation at 5\um~ and
  about 7\% at 50\um. The left legend relates line colors to wavelengths, the
  right legend indicates the line type for each of the three tilt-set
  runs. Annotations near the figure bottom indicate the viewer direction;
  spacing in both profiles is 15\qd.
\label{KLAx}  KLAx.png  }
\end{figure} 
% how made:  beaming.pro 7 ,71

Check on Solar dec is in Fig \ref{slope20noon}, when the sdec plot @253 would indicate it was near minimum

\begin{figure}[!ht] \igq{slope20noon}
\caption[slope20noon]{Temperatures at all latitudes and azimuths at noon for
  slope 20\qd; using t4 for date=6090 and slope index 10. Sub-solar declination
  must be near the crossing point, as sun near zenith would minimize effect of
  azimuth.
\label{slope20noon}  slope20noon.png  }
\end{figure} 
% how made:

%\clearpage %__________________________________________________________

 \section{Testing 2016 Oct3+}
After fixing sun motion, erase all prior beam runs and do run for A alone, then
K and L at the same time; elapsed clock time about 26 min for one and 27 min for
two.

Make files thru radiance for 3 dates:
\qi 5900 Sun 33 N
\qi 6092 Sun 33 S
\qi 6100 Sun 0.6 N, spring equinox

 Run local views for several roughnesses. The fraction of high-angle slopes not
 covered by the KRC slope set is given in the following table; last 2 columns are
 with 40 and 60\qd~ max. slope files
\begin{tabbing}
inputWW \= not covered \=  High slopes\= High slopes \kill
$\theta$ \> $\overline{\theta}$ \> Max. slope \>  Max. slope \\
input   \> computed \> 40\qd  \> 60\qd \\
5 \> 3.98  \> -1.2e-07 \>  -1.2e-07 \\
15 \>  11.70 \>    0.0216 \>  0.0002 \\
25 \>  18.72  \>     0.2368  \>   0.0405 \\
35  \>  24.38 \>     \>  0.1584 \\
\end{tabbing}

 Wrote file /work1/krc/beam/BeamKLA5900H24L9w1.cub

Add source file to plot title. Result for sun 30N are in Figure 
\ref{30N72}
\begin{figure}[!ht] \igq{30N72}
\caption[Beam profiles with Sun 30N]{Viewer traverses at 30 N. See caption to Fig. \ref{KLAx}
\label{30N72} 30N72 .png  }
\end{figure} 
% how made: beaming 147 123 

 The Tb spectra for global views at H=12, L=0 for smooth models have Tb decrease
 from 5 to 50\um of 27.3K (run A) to 28.2K (run K), dotted lines in Figure
 \ref{Tb73KLA}.  Models with $\overline{\theta}=24.4$\qd have spectral
 differences over this wavelength range that are 3.34 $\pm$0.08 greater, as
 shown in Figure \ref{Tb73KLA}.

\begin{figure}[!ht] \igq{Tb73KLA}
\caption[Global Tb]{Spectral brightness temperature for 4 global views of a
  surface with $\overline{\theta}=24.4$\qd on day 5900. The highest albedo model
  (run A) has the lowest slope (weakest spectrum) and is about 4 K cooler than
  the Kheim model (run K) at 10 \um. The Lambert model (run L) is slightly
  warmer than the Kheim model in all views; about 0.5 at 5\um~ and about 0.9 at
  50\um. The dotted lines show the spectra for the smooth model for the 3 runs
  for the H=12 L=0 view.
\label{Tb73KLA} Tb73KLA .png  }
\end{figure} 
% how made: beaming 7,73

 \section{2018 sept resume}

Rerun several KRC sets. 

Make one KRC set with proper pole for comparison.


\end{document} %===============================================================

\vspace{3.mm} Impliment \qr{glob} as, only where $\cos e'_n > 0 $: 
\qb \mathcal{R}(\lambda)_n = \left[ \sum_{j=1}^\mathrm{nLat}
  \sum_{i=1}^\mathrm{nHour} \ \sum_{m=1}^\mathrm{nSlope}
  \sum_{k=1}^\mathrm{nAzi} p(\theta_m,\phi_k)\cos e_n' \ \epsilon_\lambda \left[
    \left(1-S(i,e,\psi,\theta) \right) \mathcal{R}(\lambda,k,m,i,j)
    +S(i,e,\psi,\theta) \mathcal{R_S}(\lambda,k,m,i,j) \right] \right] \qe

\qbn / \ \left[  \sum_{j=1}^\mathrm{nLat} \sum_{i=1}^\mathrm{nHour} \sum_{m=1}^\mathrm{nSlope} \sum_{k=1}^\mathrm{nAzi} p(\theta_m,\phi_k) \cos e'_n \right] \ql{igl}

=========================================== above are extracts ===============
\ref{}
\begin{figure}[!ht] \igq{}
\caption[]{
\label{}  .png  }
\end{figure} 
% how made: 

\begin{table} \caption[]{}  \label{}
\begin{verbatim}
---
\end{verbatim}
\vspace{-3.0mm}
\hrulefill \end{table}  

\begin{tabbing} 
WWWWW \= WWWWWWWW \=   \kill 
Band \>  MAR dist \> $\Delta$ time \\
Pan  \>   8.76251 \>   \\
Blue  \> 7.15168  \>    28.67 \\
SWIR1  \>  \> todo  \\
Cirrus \>     30.7446   \>  ? 21.05 \\
\end{tabbing}
